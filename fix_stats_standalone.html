<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #45a049;
        }
        .button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .log {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
        .warning {
            color: orange;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞</h1>
        
        <div>
            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase</h3>
            <input type="text" id="supabaseUrl" placeholder="URL –≤–∞—à–µ–≥–æ Supabase –ø—Ä–æ–µ–∫—Ç–∞" />
            <input type="text" id="supabaseKey" placeholder="Anon key –≤–∞—à–µ–≥–æ Supabase –ø—Ä–æ–µ–∫—Ç–∞" />
            <button class="button" onclick="testConnection()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
        </div>
        
        <div>
            <h3>–î–µ–π—Å—Ç–≤–∏—è</h3>
            <button class="button" onclick="checkCurrentStats()" id="checkBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
            <button class="button" onclick="fixMonthlyStats()" id="fixBtn" disabled>–ò—Å–ø—Ä–∞–≤–∏—Ç—å –º–µ—Å—è—á–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
            <button class="button" onclick="addTestReceipt()" id="addBtn" disabled>–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —á–µ–∫</button>
            <button class="button" onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
        </div>
        
        <div>
            <h3>–õ–æ–≥ –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        let supabase = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function testConnection() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            
            if (!url || !key) {
                log('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ URL –∏ –∫–ª—é—á Supabase', 'error');
                return;
            }
            
            try {
                supabase = window.supabase.createClient(url, key);
                log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
                
                // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏
                document.getElementById('checkBtn').disabled = false;
                document.getElementById('fixBtn').disabled = false;
                document.getElementById('addBtn').disabled = false;
            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message, 'error');
            }
        }
        
        async function checkCurrentStats() {
            if (!supabase) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase', 'error');
                return;
            }
            
            log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã
                const { data: products, error: productsError } = await supabase
                    .from('products')
                    .select('*')
                    .eq('family_id', 1);
                
                if (productsError) {
                    log('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤: ' + productsError.message, 'error');
                } else {
                    log(`üì¶ –ü—Ä–æ–¥—É–∫—Ç–æ–≤: ${products.length}`, 'success');
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ–∫–∏
                const { data: receipts, error: receiptsError } = await supabase
                    .from('receipts')
                    .select('*')
                    .eq('family_id', 1);
                
                if (receiptsError) {
                    log('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —á–µ–∫–æ–≤: ' + receiptsError.message, 'error');
                } else {
                    log(`üßæ –ß–µ–∫–æ–≤: ${receipts.length}`, 'success');
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const { data: stats, error: statsError } = await supabase
                    .from('monthly_stats')
                    .select('*')
                    .eq('family_id', 1)
                    .order('year', { ascending: false })
                    .order('month', { ascending: false });
                
                if (statsError) {
                    log('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + statsError.message, 'error');
                } else {
                    log(`üìä –ó–∞–ø–∏—Å–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${stats.length}`, 'success');
                    stats.forEach(stat => {
                        log(`${stat.year}-${stat.month}: $${stat.total_spent}, ${stat.total_calories} –∫–∞–ª–æ—Ä–∏–π, ${stat.receipts_count} —á–µ–∫–æ–≤`);
                    });
                }
                
            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        async function fixMonthlyStats() {
            if (!supabase) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase', 'error');
                return;
            }
            
            log('üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –º–µ—Å—è—á–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...');
            
            try {
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const { error: deleteError } = await supabase
                    .from('monthly_stats')
                    .delete()
                    .eq('family_id', 1);
                
                if (deleteError) {
                    log('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + deleteError.message, 'error');
                    return;
                }
                
                log('‚úÖ –°—Ç–∞—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
                
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –æ–∫—Ç—è–±—Ä—è 2024
                const { data: octoberData, error: octoberError } = await supabase
                    .rpc('recalculate_monthly_stats', {
                        p_family_id: 1,
                        p_month: '10',
                        p_year: 2024
                    });
                
                if (octoberError) {
                    log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –æ–∫—Ç—è–±—Ä—è: ' + octoberError.message, 'warning');
                } else {
                    log('‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –æ–∫—Ç—è–±—Ä—å –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–∞', 'success');
                }
                
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –Ω–æ—è–±—Ä—è 2024
                const { data: novemberData, error: novemberError } = await supabase
                    .rpc('recalculate_monthly_stats', {
                        p_family_id: 1,
                        p_month: '11',
                        p_year: 2024
                    });
                
                if (novemberError) {
                    log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –Ω–æ—è–±—Ä—è: ' + novemberError.message, 'warning');
                } else {
                    log('‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –Ω–æ—è–±—Ä—å –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–∞', 'success');
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                await checkCurrentStats();
                
                log('üéâ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞! –¢–µ–ø–µ—Ä—å –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è', 'success');
                
            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + error.message, 'error');
            }
        }
        
        async function addTestReceipt() {
            if (!supabase) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase', 'error');
                return;
            }
            
            log('‚ûï –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —á–µ–∫...');
            
            try {
                // –°–æ–∑–¥–∞–µ–º —á–µ–∫
                const { data: receipt, error: receiptError } = await supabase
                    .from('receipts')
                    .insert({
                        family_id: 1,
                        date: '2024-11-02',
                        items_count: 2,
                        total_amount: 8.50,
                        status: 'processed'
                    })
                    .select()
                    .single();
                
                if (receiptError) {
                    log('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–µ–∫–∞: ' + receiptError.message, 'error');
                    return;
                }
                
                log('‚úÖ –ß–µ–∫ —Å–æ–∑–¥–∞–Ω: ' + receipt.id, 'success');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –≤ –∏—Å—Ç–æ—Ä–∏—é
                const { error: historyError } = await supabase
                    .from('product_history')
                    .insert([
                        {
                            product_id: 5, // –Ø–±–ª–æ–∫–∏
                            family_id: 1,
                            date: '2024-11-02',
                            quantity: 1,
                            price: 2.50,
                            unit_price: 2.50
                        },
                        {
                            product_id: 6, // –ë–∞–Ω–∞–Ω—ã
                            family_id: 1,
                            date: '2024-11-02',
                            quantity: 2,
                            price: 3.60,
                            unit_price: 1.80
                        }
                    ]);
                
                if (historyError) {
                    log('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏: ' + historyError.message, 'error');
                    return;
                }
                
                log('‚úÖ –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
                
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                log('üîÑ –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...');
                await fixMonthlyStats();
                
            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —á–µ–∫–∞: ' + error.message, 'error');
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –∏–∑ localStorage –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        window.onload = function() {
            const savedUrl = localStorage.getItem('supabaseUrl');
            const savedKey = localStorage.getItem('supabaseKey');
            
            if (savedUrl) {
                document.getElementById('supabaseUrl').value = savedUrl;
            }
            if (savedKey) {
                document.getElementById('supabaseKey').value = savedKey;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            document.getElementById('supabaseUrl').addEventListener('input', function() {
                localStorage.setItem('supabaseUrl', this.value);
            });
            
            document.getElementById('supabaseKey').addEventListener('input', function() {
                localStorage.setItem('supabaseKey', this.value);
            });
        };
    </script>
</body>
</html>
