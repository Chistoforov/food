# Исправление: Креветки остаются "в наличии" после досрочного окончания

**Дата:** 15 ноября 2025  
**Проблема:** После нажатия на кнопку "Досрочное окончание" (оранжевая кнопка с треугольником) креветки и другие продукты остаются со статусом "В наличии" (зеленая карточка) вместо "Заканчивается" (оранжевая карточка)

## Причина проблемы

SQL функция `calculate_product_type_status()` в базе данных не учитывает досрочное окончание. Она проверяет только дату последней покупки и применяет "правило 2 дней" (продукт всегда "в наличии" в первые 2 дня после покупки), но не проверяет, была ли последняя запись в истории досрочным окончанием (quantity=-1).

**Что происходит сейчас:**
1. ✅ Пользователь нажимает кнопку "Досрочное окончание" для креветок
2. ✅ Создается запись в истории с `quantity=-1`
3. ✅ Обновляется `last_purchase` на сегодня
4. ✅ Пересчитывается статистика типов продуктов
5. ❌ SQL функция видит, что `last_purchase` = сегодня, и возвращает статус `'ok'` (правило 2 дней)
6. ❌ Креветки остаются "в наличии" вместо "заканчиваются"

## Решение

Обновить SQL функцию `calculate_product_type_status()`, чтобы она:
1. **ПРИОРИТЕТ 1:** Проверяла последнюю запись в истории каждого продукта
2. Если последняя запись = `quantity=-1` → статус = `'ending-soon'` (независимо от даты)
3. **ПРИОРИТЕТ 2:** Правило 2 дней применяется только для обычных покупок
4. **ПРИОРИТЕТ 3:** Обычная логика на основе `avg_days` и `predicted_end`

## Как применить исправление

### Шаг 1: Откройте Supabase Dashboard

1. Зайдите на [supabase.com](https://supabase.com)
2. Откройте ваш проект **Grocery**
3. Перейдите в раздел **SQL Editor** (левое меню)

### Шаг 2: Выполните SQL миграцию

1. Нажмите **+ New Query**
2. Откройте файл `migration_fix_early_depletion_in_cache.sql` из вашего проекта
3. Скопируйте весь код из файла
4. Вставьте в SQL Editor
5. Нажмите **Run** (или Ctrl+Enter / Cmd+Enter)

### Шаг 3: Проверьте результат

Вы должны увидеть сообщение:
```
Success. No rows returned
```

Это означает, что функция успешно пересоздана.

### Шаг 4: Пересчитайте кэш статистики

После применения миграции нужно один раз пересчитать кэш для вашей семьи:

```sql
-- Замените 1 на ID вашей семьи, если он другой
SELECT recalculate_product_type_stats(1);
```

### Шаг 5: Проверьте работу в приложении

1. Откройте приложение Grocery Tracker
2. Обновите страницу (F5 или Cmd+R)
3. Найдите продукт со статусом "В наличии" (зеленая карточка)
4. Нажмите оранжевую кнопку с треугольником (Досрочное окончание)
5. Карточка должна стать оранжевой "Заканчивается" ✅

## Технические детали

### Что изменилось в SQL функции

**Было:**
```sql
-- Проверяем только дату покупки
IF v_days_since_purchase < 2 THEN
  v_has_recent_purchase := true;
  EXIT;
END IF;

IF v_has_recent_purchase THEN
  RETURN 'ok'; -- Всегда возвращаем 'ok' для недавних покупок
END IF;
```

**Стало:**
```sql
-- Сначала проверяем досрочное окончание (quantity=-1)
SELECT ph.quantity INTO v_last_history_quantity
FROM product_history ph
WHERE ph.product_id = v_product_record.id
ORDER BY ph.date DESC, ph.id DESC
LIMIT 1;

IF v_last_history_quantity = -1 THEN
  v_is_early_depletion := true;
END IF;

-- ПРИОРИТЕТ 1: Досрочное окончание → 'ending-soon'
IF v_is_early_depletion THEN
  RETURN 'ending-soon';
END IF;

-- ПРИОРИТЕТ 2: Правило 2 дней (только для обычных покупок)
IF v_days_since_purchase < 2 AND v_last_history_quantity != -1 THEN
  RETURN 'ok';
END IF;
```

## Тестирование

### Тест 1: Досрочное окончание
- ✅ Нажать кнопку досрочного окончания для креветок
- ✅ Карточка должна стать оранжевой "Заканчивается"
- ✅ Должна появиться зеленая кнопка "Есть в наличии"

### Тест 2: Виртуальная покупка после досрочного окончания
- ✅ Нажать зеленую кнопку "Есть в наличии" 
- ✅ Карточка должна стать зеленой "В наличии"
- ✅ Должна появиться оранжевая кнопка досрочного окончания

### Тест 3: Правило 2 дней для обычных покупок
- ✅ Загрузить чек с креветками
- ✅ В первые 2 дня статус должен быть "В наличии"
- ✅ После 2 дней статус рассчитывается по `avg_days`

## Связанные файлы

- `migration_fix_early_depletion_in_cache.sql` - SQL миграция для применения
- `src/services/supabaseService.ts` - клиентская логика (без изменений)
- `src/GroceryTrackerApp.tsx` - UI и обработчики (без изменений)
- `migration_add_product_type_stats_cache.sql` - оригинальная миграция с кэшем

## История изменений

- **15 ноября 2025:** Создана миграция для исправления функции `calculate_product_type_status()`
- **Предыдущие исправления:** Клиентская логика уже была исправлена в `calculateProductStats()` (TypeScript)
- **Проблема:** SQL функция не была синхронизирована с клиентской логикой

## Примечания

- Это исправление затрагивает только SQL функцию в базе данных
- Клиентский код в TypeScript уже работает правильно
- После применения миграции все будет работать корректно
- Миграция обратно совместима и не сломает существующие данные





