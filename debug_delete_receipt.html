<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–µ–∫–æ–≤</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .log { max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–µ–∫–æ–≤</h1>
    
    <div class="section">
        <h3>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è</h3>
        <div id="env-check"></div>
    </div>
    
    <div class="section">
        <h3>2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase</h3>
        <div id="connection-check"></div>
    </div>
    
    <div class="section">
        <h3>3. –ü—Ä–æ–≤–µ—Ä–∫–∞ RLS –ø–æ–ª–∏—Ç–∏–∫</h3>
        <div id="rls-check"></div>
    </div>
    
    <div class="section">
        <h3>4. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–µ–∫–æ–≤</h3>
        <div id="receipts-list"></div>
    </div>
    
    <div class="section">
        <h3>5. –¢–µ—Å—Ç —É–¥–∞–ª–µ–Ω–∏—è</h3>
        <div id="delete-test"></div>
    </div>
    
    <div class="section">
        <h3>6. –õ–æ–≥ –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    </div>

    <script type="module">
        let supabase;
        let receipts = [];
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function setStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `section ${type}`;
            element.innerHTML = `<p>${message}</p>`;
        }
        
        async function checkEnvironment() {
            log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è...');
            
            const supabaseUrl = import.meta.env?.VITE_SUPABASE_URL || window.VITE_SUPABASE_URL;
            const supabaseKey = import.meta.env?.VITE_SUPABASE_ANON_KEY || window.VITE_SUPABASE_ANON_KEY;
            
            if (!supabaseUrl) {
                setStatus('env-check', '‚ùå VITE_SUPABASE_URL –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                log('‚ùå VITE_SUPABASE_URL –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return false;
            }
            
            if (!supabaseKey) {
                setStatus('env-check', '‚ùå VITE_SUPABASE_ANON_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                log('‚ùå VITE_SUPABASE_ANON_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return false;
            }
            
            setStatus('env-check', '‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞–π–¥–µ–Ω—ã', 'success');
            log(`‚úÖ Supabase URL: ${supabaseUrl}`, 'success');
            log(`‚úÖ Supabase Key: ${supabaseKey.substring(0, 20)}...`, 'success');
            
            return { supabaseUrl, supabaseKey };
        }
        
        async function checkConnection(env) {
            log('üîó –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase...');
            
            try {
                const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js@2');
                supabase = createClient(env.supabaseUrl, env.supabaseKey);
                
                // –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                const { data, error } = await supabase.from('families').select('count').limit(1);
                
                if (error) {
                    setStatus('connection-check', `‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
                    log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
                    return false;
                }
                
                setStatus('connection-check', '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —É—Å–ø–µ—à–Ω–æ', 'success');
                log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —É—Å–ø–µ—à–Ω–æ', 'success');
                return true;
                
            } catch (error) {
                setStatus('connection-check', `‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
                log(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function checkRLS() {
            log('üîí –ü—Ä–æ–≤–µ—Ä—è–µ–º RLS –ø–æ–ª–∏—Ç–∏–∫–∏...');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á–µ–Ω –ª–∏ RLS
                const { data: tables, error: tablesError } = await supabase
                    .rpc('exec_sql', {
                        sql: `
                            SELECT tablename, rowsecurity 
                            FROM pg_tables 
                            WHERE schemaname = 'public' 
                            AND tablename IN ('receipts', 'product_history')
                        `
                    });
                
                if (tablesError) {
                    log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å RLS —á–µ—Ä–µ–∑ RPC, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±...', 'warning');
                    
                    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± - –ø—Ä–æ–±—É–µ–º —É–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–ø–∏—Å—å
                    const { data: testReceipts } = await supabase
                        .from('receipts')
                        .select('id')
                        .limit(1);
                    
                    if (testReceipts && testReceipts.length > 0) {
                        const testId = testReceipts[0].id;
                        const { error: deleteError } = await supabase
                            .from('receipts')
                            .delete()
                            .eq('id', testId);
                        
                        if (deleteError && deleteError.message.includes('policy')) {
                            setStatus('rls-check', '‚ùå RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã - —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ', 'error');
                            log(`‚ùå RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã: ${deleteError.message}`, 'error');
                            return false;
                        } else if (deleteError) {
                            setStatus('rls-check', `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è: ${deleteError.message}`, 'error');
                            log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è: ${deleteError.message}`, 'error');
                            return false;
                        } else {
                            setStatus('rls-check', '‚úÖ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ', 'success');
                            log('‚úÖ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ', 'success');
                            return true;
                        }
                    } else {
                        setStatus('rls-check', '‚ö†Ô∏è –ù–µ—Ç —á–µ–∫–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è RLS', 'warning');
                        log('‚ö†Ô∏è –ù–µ—Ç —á–µ–∫–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è RLS', 'warning');
                        return true;
                    }
                } else {
                    const receiptsRLS = tables.find(t => t.tablename === 'receipts')?.rowsecurity;
                    const historyRLS = tables.find(t => t.tablename === 'product_history')?.rowsecurity;
                    
                    if (receiptsRLS && historyRLS) {
                        setStatus('rls-check', '‚úÖ RLS –≤–∫–ª—é—á–µ–Ω –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü', 'success');
                        log('‚úÖ RLS –≤–∫–ª—é—á–µ–Ω –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü', 'success');
                        return true;
                    } else {
                        setStatus('rls-check', '‚ùå RLS –Ω–µ –≤–∫–ª—é—á–µ–Ω –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü', 'error');
                        log('‚ùå RLS –Ω–µ –≤–∫–ª—é—á–µ–Ω –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü', 'error');
                        return false;
                    }
                }
                
            } catch (error) {
                setStatus('rls-check', `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ RLS: ${error.message}`, 'error');
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ RLS: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function getReceipts() {
            log('üìã –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —á–µ–∫–æ–≤...');
            
            try {
                const { data, error } = await supabase
                    .from('receipts')
                    .select('*')
                    .eq('family_id', 1)
                    .order('date', { ascending: false });
                
                if (error) {
                    setStatus('receipts-list', `‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —á–µ–∫–æ–≤: ${error.message}`, 'error');
                    log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —á–µ–∫–æ–≤: ${error.message}`, 'error');
                    return false;
                }
                
                receipts = data || [];
                setStatus('receipts-list', `‚úÖ –ù–∞–π–¥–µ–Ω–æ —á–µ–∫–æ–≤: ${receipts.length}`, 'success');
                log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ —á–µ–∫–æ–≤: ${receipts.length}`, 'success');
                
                if (receipts.length > 0) {
                    const receiptsHtml = receipts.map(r => `
                        <div style="margin: 5px 0; padding: 10px; border: 1px solid #ddd; border-radius: 3px;">
                            <strong>ID:</strong> ${r.id} | 
                            <strong>–î–∞—Ç–∞:</strong> ${r.date} | 
                            <strong>–°—É–º–º–∞:</strong> ‚Ç¨${r.total_amount} | 
                            <strong>–¢–æ–≤–∞—Ä–æ–≤:</strong> ${r.items_count}
                        </div>
                    `).join('');
                    
                    document.getElementById('receipts-list').innerHTML += receiptsHtml;
                }
                
                return true;
                
            } catch (error) {
                setStatus('receipts-list', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testDelete() {
            if (receipts.length === 0) {
                setStatus('delete-test', '‚ö†Ô∏è –ù–µ—Ç —á–µ–∫–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è', 'warning');
                log('‚ö†Ô∏è –ù–µ—Ç —á–µ–∫–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è', 'warning');
                return;
            }
            
            const receiptToDelete = receipts[0];
            log(`üóëÔ∏è –¢–µ—Å—Ç–∏—Ä—É–µ–º —É–¥–∞–ª–µ–Ω–∏–µ —á–µ–∫–∞ #${receiptToDelete.id}...`);
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ product_history
                const { data: relatedHistory, error: historyError } = await supabase
                    .from('product_history')
                    .select('id')
                    .eq('receipt_id', receiptToDelete.id);
                
                if (!historyError && relatedHistory) {
                    log(`üìä –°–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π product_history: ${relatedHistory.length}`);
                }
                
                // –£–¥–∞–ª—è–µ–º —á–µ–∫
                const { error: deleteError } = await supabase
                    .from('receipts')
                    .delete()
                    .eq('id', receiptToDelete.id);
                
                if (deleteError) {
                    setStatus('delete-test', `‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${deleteError.message}`, 'error');
                    log(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${deleteError.message}`, 'error');
                    
                    if (deleteError.message.includes('policy') || deleteError.message.includes('RLS')) {
                        log('üí° –†–ï–®–ï–ù–ò–ï: –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL-—Å–∫—Ä–∏–ø—Ç –∏–∑ —Ñ–∞–π–ª–∞ setup_rls_policies.sql', 'error');
                    }
                    
                    return false;
                }
                
                log('‚úÖ –ß–µ–∫ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö!', 'success');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —á–µ–∫ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª–µ–Ω
                const { data: checkReceipt, error: checkError } = await supabase
                    .from('receipts')
                    .select('id')
                    .eq('id', receiptToDelete.id)
                    .single();
                
                if (checkError || !checkReceipt) {
                    setStatus('delete-test', '‚úÖ –ß–µ–∫ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω! –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.', 'success');
                    log('‚úÖ –ß–µ–∫ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª–µ–Ω –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö!', 'success');
                } else {
                    setStatus('delete-test', '‚ùå –ß–µ–∫ –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î!', 'error');
                    log('‚ùå –ß–µ–∫ –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î!', 'error');
                }
                
                return true;
                
            } catch (error) {
                setStatus('delete-test', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function runDiagnostics() {
            log('üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É...');
            
            const env = await checkEnvironment();
            if (!env) return;
            
            const connected = await checkConnection(env);
            if (!connected) return;
            
            const rlsOk = await checkRLS();
            if (!rlsOk) {
                log('üí° –í–´–ü–û–õ–ù–ò–¢–ï: SQL-—Å–∫—Ä–∏–ø—Ç –∏–∑ —Ñ–∞–π–ª–∞ setup_rls_policies.sql', 'error');
                return;
            }
            
            const receiptsOk = await getReceipts();
            if (!receiptsOk) return;
            
            await testDelete();
            
            log('üéâ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!', 'success');
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        runDiagnostics();
        
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–æ–Ω—Å–æ–ª–∏
        window.runDiagnostics = runDiagnostics;
        window.testDelete = testDelete;
        window.clearLog = clearLog;
    </script>
</body>
</html>
