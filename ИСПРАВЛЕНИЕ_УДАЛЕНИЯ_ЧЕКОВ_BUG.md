# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–µ–∫–æ–≤

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —á–µ–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:
```
DELETE https://...supabase.co/rest/v1/receipts?id=eq.64 400 (Bad Request)
–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–µ–∫–∞: {code: '22P02', details: null, hint: null, message: 'invalid input syntax for type integer: "2025-10"'}
```

## üîç –ü—Ä–∏—á–∏–Ω–∞

–í —Ç—Ä–∏–≥–≥–µ—Ä–∞—Ö —É–¥–∞–ª–µ–Ω–∏—è —á–µ–∫–æ–≤ (`recalculate_stats_after_receipt_delete` –∏ `recalculate_stats_on_history_delete`) –≤ —Ñ—É–Ω–∫—Ü–∏—é `recalculate_monthly_stats` –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –º–µ—Å—è—Ü–∞:

**–ë—ã–ª–æ:**
```sql
PERFORM recalculate_monthly_stats(OLD.family_id, v_year || '-' || v_month, v_year);
-- –ü–µ—Ä–µ–¥–∞–≤–∞–ª–æ—Å—å: "2025-10" –≤–º–µ—Å—Ç–æ "10"
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```sql
PERFORM recalculate_monthly_stats(OLD.family_id, v_month, v_year);
-- –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è: "10"
```

–§—É–Ω–∫—Ü–∏—è `recalculate_monthly_stats` –æ–∂–∏–¥–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
- `p_family_id INTEGER` (ID —Å–µ–º—å–∏)
- `p_month VARCHAR(10)` (–º–µ—Å—è—Ü –≤ —Ñ–æ—Ä–º–∞—Ç–µ "10", –∞ –Ω–µ "2025-10")
- `p_year INTEGER` (–≥–æ–¥)

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL —Å–∫—Ä–∏–ø—Ç –≤ Supabase

1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **SQL Editor**
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ `fix_delete_receipt_trigger.sql`

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é `recalculate_stats_after_receipt_delete()`
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é `recalculate_stats_on_history_delete()`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
- ‚úÖ –í—ã–≤–æ–¥–∏—Ç —Å—Ç–∞—Ç—É—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —É–¥–∞–ª–∏—Ç—å —á–µ–∫:

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É "–ó–∞–≥—Ä—É–∑–∏—Ç—å —á–µ–∫"
3. –ù–∞–π–¥–∏—Ç–µ –ª—é–±–æ–π —á–µ–∫ –≤ —Å–ø–∏—Å–∫–µ
4. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É –∫–æ—Ä–∑–∏–Ω—ã
5. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ

–ß–µ–∫ –¥–æ–ª–∂–µ–Ω —É–¥–∞–ª–∏—Ç—å—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫!

## üìù –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### –§–∞–π–ª—ã –≤ –∫–æ–¥–µ (—É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã):
- ‚úÖ `migration_auto_delete_products.sql` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ `migration_add_receipt_id.sql` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏

### –§–∞–π–ª –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:
- ‚úÖ `fix_delete_receipt_trigger.sql` - SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ Supabase

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1. **–£–¥–∞–ª–µ–Ω–∏–µ —á–µ–∫–∞** - —á–µ–∫ —É–¥–∞–ª—è–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
2. **–ü–µ—Ä–µ—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏** - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. **–£–¥–∞–ª–µ–Ω–∏–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤** - —Ç–æ–≤–∞—Ä—ã –±–µ–∑ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–∫—É–ø–æ–∫ —É–¥–∞–ª—è—é—Ç—Å—è
4. **–ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞** - –Ω–µ—Ç –æ—à–∏–±–æ–∫ 400 (Bad Request)

## ‚ùì –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–ª–∞—Å—å

–ï—Å–ª–∏ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –∏—Å—á–µ–∑–ª–∞:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–∏–ª—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ –≤ SQL Editor
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç:

```sql
SELECT tgname, tgrelid::regclass 
FROM pg_trigger 
WHERE tgname IN ('recalculate_stats_on_receipt_delete', 'recalculate_stats_on_history_delete_trigger');
```

4. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é, –≤—ã–ø–æ–ª–Ω–∏–≤ `migration_auto_delete_products.sql` –∑–∞–Ω–æ–≤–æ

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- –§—É–Ω–∫—Ü–∏—è `recalculate_monthly_stats` –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ñ–∞–π–ª–µ `database_schema.sql`
- –¢—Ä–∏–≥–≥–µ—Ä—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ —Ñ–∞–π–ª–µ `migration_auto_delete_products.sql`
- –õ–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–µ–∫–æ–≤ –≤ `src/services/supabaseService.ts` (–º–µ—Ç–æ–¥ `deleteReceipt`)

