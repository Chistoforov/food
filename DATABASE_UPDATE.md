# Обновление базы данных для автоматического пересчета статистики

## Описание изменений

Добавлена функциональность автоматического пересчета статистики при изменении калорийности продукта. Теперь при изменении калорийности продукта статистика будет автоматически пересчитываться для всех месяцев, где есть покупки этого продукта.

## Новые функции и триггеры

### 1. Функция `recalculate_monthly_stats`
Пересчитывает месячную статистику для указанной семьи, месяца и года:
- Общая сумма потраченная в месяце
- Общее количество калорий (с учетом количества купленных продуктов)
- Среднее количество калорий в день
- Количество чеков

### 2. Функция `recalculate_stats_on_product_change`
Триггерная функция, которая вызывается при изменении продукта:
- Пересчитывает статистику для текущего месяца
- Если изменилась калорийность, пересчитывает статистику для всех месяцев, где есть покупки этого продукта

### 3. Функция `recalculate_stats_on_history_insert`
Триггерная функция, которая вызывается при добавлении новой покупки:
- Пересчитывает статистику для месяца покупки

### 4. Триггеры
- `recalculate_stats_on_product_update` - срабатывает при обновлении продукта
- `recalculate_stats_on_history_insert` - срабатывает при добавлении новой покупки

## Инструкции по развертыванию

### 1. Выполните SQL-скрипт
Запустите обновленный `database_schema.sql` в вашей базе данных Supabase:

```sql
-- Выполните все новые функции и триггеры из database_schema.sql
```

### 2. Проверьте права доступа
Убедитесь, что пользователь базы данных имеет права на выполнение функций и создание триггеров.

### 3. Тестирование
После развертывания протестируйте функциональность:

1. Измените калорийность продукта в интерфейсе
2. Проверьте, что статистика обновилась автоматически
3. Добавьте новую покупку продукта
4. Убедитесь, что статистика пересчиталась

## API изменения

### Новые методы в SupabaseService

1. `recalculateMonthlyStats(familyId, month, year)` - ручной пересчет статистики
2. `recalculateStatsForProduct(productId, familyId)` - пересчет статистики для продукта

### Обновленные хуки

1. `useProducts` - автоматически пересчитывает статистику при изменении калорийности
2. `useMonthlyStats` - добавлен метод `recalculateStats` для ручного пересчета

## Преимущества

1. **Автоматический пересчет** - статистика обновляется автоматически при изменении данных
2. **Точность данных** - статистика всегда актуальна
3. **Производительность** - пересчет происходит только при необходимости
4. **Удобство** - пользователю не нужно вручную обновлять статистику

## Обратная совместимость

Все изменения обратно совместимы. Существующие данные не изменятся, а новая функциональность будет работать с текущими данными.
