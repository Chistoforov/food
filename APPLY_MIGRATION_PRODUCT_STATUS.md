# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤

## –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–æ–¥—É–∫—Ç—ã, –∫—É–ø–ª–µ–Ω–Ω—ã–µ —Å–µ–≥–æ–¥–Ω—è –∏–ª–∏ –≤—á–µ—Ä–∞, –º–æ–≥–ª–∏ –ø–æ–ª—É—á–∞—Ç—å —Å—Ç–∞—Ç—É—Å "–∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è" –∏–∑-–∑–∞ –º–∞–ª–æ–≥–æ —Å—Ä–µ–¥–Ω–µ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –º–µ–∂–¥—É –ø–æ–∫—É–ø–∫–∞–º–∏.

## –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. Frontend (TypeScript)
‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤ `src/services/supabaseService.ts`:
- –ï—Å–ª–∏ –ø—Ä–æ–¥—É–∫—Ç –∫—É–ø–ª–µ–Ω –º–µ–Ω–µ–µ 2 –¥–Ω–µ–π –Ω–∞–∑–∞–¥, —Å—Ç–∞—Ç—É—Å –≤—Å–µ–≥–¥–∞ = `ok`
- –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–∏—Ç—É–∞—Ü–∏—é, –∫–æ–≥–¥–∞ —Ç–æ–ª—å–∫–æ —á—Ç–æ –∫—É–ø–ª–µ–Ω–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ "–∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è"

### 2. Backend (API)
‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `api/process-receipt.js`:
- –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–µ–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Å—Ç–∞—Ç—É—Å—ã –≤—Å–µ—Ö –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–æ–≤–∞—è SQL —Ñ—É–Ω–∫—Ü–∏—è `update_product_analytics`

### 3. Database (SQL Function)
üìù –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `migration_update_product_stats_function.sql`:
- RPC —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∞
- –†–µ–∞–ª–∏–∑—É–µ—Ç —Ç—É –∂–µ –ª–æ–≥–∏–∫—É, —á—Ç–æ –∏ TypeScript –∫–æ–¥

## –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ Supabase Dashboard (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. –û—Ç–∫—Ä–æ–π—Ç–µ [Supabase Dashboard](https://app.supabase.com)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –≤–∞—à –ø—Ä–æ–µ–∫—Ç
3. –û—Ç–∫—Ä–æ–π—Ç–µ **SQL Editor** (—Å–ª–µ–≤–∞ –≤ –º–µ–Ω—é)
4. –ù–∞–∂–º–∏—Ç–µ **New Query**
5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ `migration_update_product_stats_function.sql`
6. –í—Å—Ç–∞–≤—å—Ç–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏ –Ω–∞–∂–º–∏—Ç–µ **Run**

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ Supabase CLI

```bash
# –ï—Å–ª–∏ —É –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Supabase CLI
supabase db push migration_update_product_stats_function.sql
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ß–µ—Ä–µ–∑ psql

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –≤–∞—à–µ–π –±–∞–∑–µ —á–µ—Ä–µ–∑ psql
psql "postgresql://postgres:[YOUR-PASSWORD]@[YOUR-PROJECT-REF].supabase.co:5432/postgres"

# –í—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é
\i migration_update_product_stats_function.sql
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏**:
```sql
SELECT routine_name 
FROM information_schema.routines 
WHERE routine_name = 'update_product_analytics';
```

2. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é**:
```sql
-- –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Å—Ç–∞—Ç—É—Å –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞ —Å ID 182 (–ö–∏–Ω–¥–µ—Ä)
SELECT update_product_analytics(182, 1);

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
SELECT name, status, last_purchase, avg_days, predicted_end 
FROM products 
WHERE id = 182;
```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏**:
   - –û—Ç–∫—Ä–æ–π—Ç–µ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
   - –ö–∞—Ç–µ–≥–æ—Ä–∏—è "–∫–∏–Ω–¥–µ—Ä" —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å:
     - –í—Å–µ–≥–æ: 1
     - –í –Ω–∞–ª–∏—á–∏–∏: 1 (–≤–º–µ—Å—Ç–æ "–ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è: 1")

## –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
–ö–∏–Ω–¥–µ—Ä
–í—Å–µ–≥–æ: 1
–ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è: 1 ‚ùå
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
–ö–∏–Ω–¥–µ—Ä
–í—Å–µ–≥–æ: 1
–í –Ω–∞–ª–∏—á–∏–∏: 1 ‚úÖ
```

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—Å–µ –Ω–æ–≤—ã–µ —á–µ–∫–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å—ã –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Å —É—á–µ—Ç–æ–º –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏:
- –ü—Ä–æ–¥—É–∫—Ç—ã, –∫—É–ø–ª–µ–Ω–Ω—ã–µ —Å–µ–≥–æ–¥–Ω—è –∏–ª–∏ –≤—á–µ—Ä–∞ ‚Üí —Å—Ç–∞—Ç—É—Å `ok`
- –ü—Ä–æ–¥—É–∫—Ç—ã, –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫–æ—Ç–æ—Ä—ã—Ö ‚â§ 2 –¥–Ω–µ–π ‚Üí —Å—Ç–∞—Ç—É—Å `ending-soon`
- –ü—Ä–æ–¥—É–∫—Ç—ã —Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ ‚Üí —Å—Ç–∞—Ç—É—Å `calculating`

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞

```javascript
if (daysSincePurchase < 2) {
  status = 'ok'  // –ü—Ä–æ–¥—É–∫—Ç –∫—É–ø–ª–µ–Ω –Ω–µ–¥–∞–≤–Ω–æ
} else if (daysUntilEnd <= 2) {
  status = 'ending-soon'  // –°–∫–æ—Ä–æ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è
} else {
  status = 'ok'  // –í—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ
}
```

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑

1. –°–∏—Å—Ç–µ–º–∞ —Å–æ–±–∏—Ä–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –ø–æ–∫—É–ø–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–∞ (–∏–ª–∏ –≤—Å–µ—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —ç—Ç–æ–≥–æ —Ç–∏–ø–∞)
2. –í—ã—á–∏—Å–ª—è–µ—Ç —Å—Ä–µ–¥–Ω–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø–æ–∫—É–ø–∫–∞–º–∏
3. –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ—Ç –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è = –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–∫—É–ø–∫–∞ + —Å—Ä–µ–¥–Ω–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
4. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π –¥–æ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–æ–π –¥–∞—Ç—ã

---

**–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏**, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Supabase –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.













