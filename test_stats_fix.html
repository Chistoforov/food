<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .error {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background: #efe;
            color: #363;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            background: #eef;
            color: #336;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>üîß –¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h1>
    
    <div class="container">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h2>
        <div>
            <label>Supabase URL:</label><br>
            <input type="text" id="supabaseUrl" placeholder="https://your-project.supabase.co" style="width: 100%; margin: 5px 0; padding: 8px;">
        </div>
        <div>
            <label>Supabase Anon Key:</label><br>
            <input type="text" id="supabaseKey" placeholder="your-anon-key" style="width: 100%; margin: 5px 0; padding: 8px;">
        </div>
        <button onclick="initSupabase()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Supabase</button>
        <div id="connectionStatus"></div>
    </div>

    <div class="container">
        <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h2>
        <button onclick="checkData()" id="checkBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ</button>
        <div id="dataStatus"></div>
    </div>

    <div class="container">
        <h2>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h2>
        <button onclick="fixStats()" id="fixBtn" disabled>–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
        <div id="fixStatus"></div>
    </div>

    <div class="container">
        <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
        <div id="result"></div>
    </div>

    <script>
        let supabase = null;

        function initSupabase() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            
            if (!url || !key) {
                showError('connectionStatus', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ URL –∏ –∫–ª—é—á Supabase');
                return;
            }

            try {
                supabase = window.supabase.createClient(url, key);
                showSuccess('connectionStatus', '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                document.getElementById('checkBtn').disabled = false;
            } catch (error) {
                showError('connectionStatus', '‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
            }
        }

        async function checkData() {
            if (!supabase) {
                showError('dataStatus', '–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ Supabase');
                return;
            }

            showLoading('dataStatus', '–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ...');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ–∫–∏
                const { data: receipts, error: receiptsError } = await supabase
                    .from('receipts')
                    .select('*')
                    .eq('family_id', 1);

                if (receiptsError) throw receiptsError;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã
                const { data: products, error: productsError } = await supabase
                    .from('products')
                    .select('*')
                    .eq('family_id', 1);

                if (productsError) throw productsError;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–∫—É–ø–æ–∫
                const { data: history, error: historyError } = await supabase
                    .from('product_history')
                    .select('*')
                    .eq('family_id', 1);

                if (historyError) throw historyError;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const { data: stats, error: statsError } = await supabase
                    .from('monthly_stats')
                    .select('*')
                    .eq('family_id', 1);

                if (statsError) throw statsError;

                let html = '<h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:</h3>';
                html += `<p><strong>–ß–µ–∫–æ–≤:</strong> ${receipts?.length || 0}</p>`;
                html += `<p><strong>–ü—Ä–æ–¥—É–∫—Ç–æ–≤:</strong> ${products?.length || 0}</p>`;
                html += `<p><strong>–ó–∞–ø–∏—Å–µ–π –≤ –∏—Å—Ç–æ—Ä–∏–∏:</strong> ${history?.length || 0}</p>`;
                html += `<p><strong>–ó–∞–ø–∏—Å–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:</strong> ${stats?.length || 0}</p>`;

                if (receipts && receipts.length > 0) {
                    html += '<h4>üìÖ –ß–µ–∫–∏ –∑–∞ –¥–µ–∫–∞–±—Ä—å 2024:</h4>';
                    const decReceipts = receipts.filter(r => {
                        const date = new Date(r.date);
                        return date.getFullYear() === 2024 && date.getMonth() === 11; // 11 = –¥–µ–∫–∞–±—Ä—å
                    });
                    html += `<p>–ù–∞–π–¥–µ–Ω–æ —á–µ–∫–æ–≤ –∑–∞ –¥–µ–∫–∞–±—Ä—å: ${decReceipts.length}</p>`;
                    if (decReceipts.length > 0) {
                        html += '<pre>' + JSON.stringify(decReceipts.slice(0, 3), null, 2) + '</pre>';
                    }
                }

                if (stats && stats.length > 0) {
                    html += '<h4>üìà –¢–µ–∫—É—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h4>';
                    html += '<pre>' + JSON.stringify(stats, null, 2) + '</pre>';
                }

                document.getElementById('dataStatus').innerHTML = html;
                document.getElementById('fixBtn').disabled = false;

            } catch (error) {
                showError('dataStatus', '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            }
        }

        async function fixStats() {
            if (!supabase) {
                showError('fixStatus', '–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ Supabase');
                return;
            }

            showLoading('fixStatus', '–ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...');
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –º–µ—Å—è—Ü—ã —Å —á–µ–∫–∞–º–∏
                const { data: receipts, error: receiptsError } = await supabase
                    .from('receipts')
                    .select('date')
                    .eq('family_id', 1);

                if (receiptsError) throw receiptsError;

                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –º–µ—Å—è—Ü–∞–º
                const months = new Map();
                receipts.forEach(receipt => {
                    const date = new Date(receipt.date);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const key = `${year}-${month}`;
                    
                    if (!months.has(key)) {
                        months.set(key, { year, month, receipts: [] });
                    }
                    months.get(key).receipts.push(receipt);
                });

                let html = '<h3>üîÑ –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –º–µ—Å—è—Ü–µ–≤:</h3>';
                html += '<ul>';
                for (const [key, data] of months) {
                    html += `<li>${key}: ${data.receipts.length} —á–µ–∫–æ–≤</li>`;
                }
                html += '</ul>';

                // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                for (const [key, data] of months) {
                    html += `<p>üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º ${key}...</p>`;
                    
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    await supabase
                        .from('monthly_stats')
                        .delete()
                        .eq('family_id', 1)
                        .eq('month', key)
                        .eq('year', data.year);

                    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞
                    const { data: monthReceipts, error: monthReceiptsError } = await supabase
                        .from('receipts')
                        .select('total_amount')
                        .eq('family_id', 1)
                        .gte('date', `${data.year}-${data.month}-01`)
                        .lt('date', `${data.year}-${String(parseInt(data.month) + 1).padStart(2, '0')}-01`);

                    if (monthReceiptsError) throw monthReceiptsError;

                    const { data: monthHistory, error: monthHistoryError } = await supabase
                        .from('product_history')
                        .select(`
                            quantity,
                            products(calories)
                        `)
                        .eq('family_id', 1)
                        .gte('date', `${data.year}-${data.month}-01`)
                        .lt('date', `${data.year}-${String(parseInt(data.month) + 1).padStart(2, '0')}-01`);

                    if (monthHistoryError) throw monthHistoryError;

                    // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    const totalSpent = monthReceipts?.reduce((sum, r) => sum + (r.total_amount || 0), 0) || 0;
                    const totalCalories = monthHistory?.reduce((sum, h) => {
                        const calories = h.products?.calories || 0;
                        const quantity = h.quantity || 0;
                        return sum + (calories * quantity);
                    }, 0) || 0;
                    
                    const daysInMonth = new Date(data.year, parseInt(data.month), 0).getDate();
                    const avgCaloriesPerDay = daysInMonth > 0 ? Math.round(totalCalories / daysInMonth) : 0;
                    const receiptsCount = monthReceipts?.length || 0;

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    const { error: insertError } = await supabase
                        .from('monthly_stats')
                        .insert({
                            family_id: 1,
                            month: key,
                            year: data.year,
                            total_spent: totalSpent,
                            total_calories: totalCalories,
                            avg_calories_per_day: avgCaloriesPerDay,
                            receipts_count: receiptsCount
                        });

                    if (insertError) throw insertError;

                    html += `<p>‚úÖ ${key}: ‚Ç¨${totalSpent.toFixed(2)}, ${totalCalories} –∫–∫–∞–ª, ${receiptsCount} —á–µ–∫–æ–≤</p>`;
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                const { data: finalStats, error: finalStatsError } = await supabase
                    .from('monthly_stats')
                    .select('*')
                    .eq('family_id', 1)
                    .order('year', { ascending: false })
                    .order('month', { ascending: false });

                if (finalStatsError) throw finalStatsError;

                html += '<h3>‚úÖ –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h3>';
                html += '<pre>' + JSON.stringify(finalStats, null, 2) + '</pre>';

                document.getElementById('fixStatus').innerHTML = html;
                showSuccess('result', '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞!');

            } catch (error) {
                showError('fixStatus', '‚ùå –û—à–∏–±–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + error.message);
            }
        }

        function showError(elementId, message) {
            document.getElementById(elementId).innerHTML = `<div class="error">${message}</div>`;
        }

        function showSuccess(elementId, message) {
            document.getElementById(elementId).innerHTML = `<div class="success">${message}</div>`;
        }

        function showLoading(elementId, message) {
            document.getElementById(elementId).innerHTML = `<div class="loading">${message}</div>`;
        }
    </script>
</body>
</html>
