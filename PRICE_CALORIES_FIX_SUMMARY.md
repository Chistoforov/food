# Сводка исправлений: Цены и калории

**Дата:** 31 октября 2025  
**Статус:** ✅ Исправлено

## Измененные файлы

### 1. `src/services/supabaseService.ts`
**Строки 458-486:** Метод `processReceipt`

**Было:**
```typescript
const unitPrice = item.quantity > 0 ? item.price / item.quantity : item.price
price: unitPrice  // Неправильно!
calories: Math.round(item.calories / (item.quantity || 1))  // Неправильно!
```

**Стало:**
```typescript
price: item.price  // Цена из чека - уже правильная!
calories: item.calories  // Калории для полного количества
```

### 2. `src/services/perplexityService.ts`
**Строки 70-96:** Промпт для AI

**Добавлено:**
- Четкие инструкции для товаров на вес
- Примеры для разных типов товаров
- Правило: `price` — это ВСЕГДА итоговая цена из чека

### 3. Новые файлы

- ✅ `fix_prices_and_calories.sql` — SQL скрипт для исправления данных
- ✅ `FIX_PRICES_CALORIES_2025.md` — Подробная документация
- ✅ `ИСПРАВЛЕНИЕ_ЦЕН_И_КАЛОРИЙ.md` — Краткая инструкция на русском

## Что исправлено

| Проблема | Решение |
|----------|---------|
| Цены делились на quantity | Теперь берутся напрямую из чека |
| Калории делились на quantity | Теперь сохраняются для полного количества |
| AI неправильно интерпретировал товары на вес | Улучшен промпт с примерами |

## Примеры исправлений

### Сыр на вес
```
Чек: 0.212 кг × 19.98€/кг = 4.24€
Было в приложении: €20.00 ❌
Стало в приложении: €4.24 ✅
```

### Упакованный товар
```
Чек: Гуакамоле 200г — 1.95€
Было в приложении: €9.75 ❌
Стало в приложении: €1.95 ✅
```

## Следующие шаги

### Для исправления существующих данных:

**Вариант A (рекомендуется):**
```sql
-- Выполните в Supabase SQL Editor:
-- Содержимое файла fix_prices_and_calories.sql
```

**Вариант B:**
- Удалите проблемные чеки
- Загрузите их заново

### Для новых чеков:
✅ Ничего делать не нужно — всё работает автоматически!

## Тестирование

После исправления проверьте:
1. ✅ Загрузите новый чек с товаром на вес
2. ✅ Проверьте, что цена соответствует чеку
3. ✅ Проверьте калории в дашборде

## Технические детали

### База данных

**Таблица `products`:**
- `price` — последняя цена покупки (как в чеке)
- `calories` — калории последней покупки

**Таблица `product_history`:**
- `price` — итоговая цена покупки
- `quantity` — купленное количество
- `unit_price` — цена за единицу (для истории)

### Логика расчетов

```typescript
// Новая логика (правильная):
product.price = item.price  // Без пересчета!
product.calories = item.calories  // Для полного количества!

// Для истории (для аналитики):
history.unit_price = item.price / item.quantity  // Только для истории
```

---

**Файлы для коммита:**
- ✅ `src/services/supabaseService.ts`
- ✅ `src/services/perplexityService.ts`
- ✅ `fix_prices_and_calories.sql`
- ✅ `FIX_PRICES_CALORIES_2025.md`
- ✅ `ИСПРАВЛЕНИЕ_ЦЕН_И_КАЛОРИЙ.md`
- ✅ `PRICE_CALORIES_FIX_SUMMARY.md`

