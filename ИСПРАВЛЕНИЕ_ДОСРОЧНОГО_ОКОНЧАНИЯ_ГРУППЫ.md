# Исправление: Кнопка досрочного окончания для групп продуктов

**Дата:** 15 ноября 2025  
**Статус:** ✅ Исправлено

## Проблема

Кнопка "Продукт закончился раньше" не работала для продуктов с типом (например "креветки"). Продукты оставались "В наличии" вместо "Заканчивается".

## Причина

Система проверяла последнюю запись в истории **всей группы** продуктов, а не конкретного продукта.

Пример:
- Креветки варёные - отметили как досрочно закончившиеся ✓
- Куриная грудка (ошибочно в типе "креветки") - обычная покупка

При проверке статуса "Креветок варёных", система смотрела последнюю запись всех "креветок", которая могла быть от "Куриной грудки" → статус не менялся ❌

## Решение

Теперь система:
1. Использует групповую историю для расчета среднего интервала (точный прогноз) ✓
2. Проверяет историю **конкретного продукта** для определения досрочного окончания ✓

## Изменения

**Файл:** `src/services/supabaseService.ts`

```typescript
// Было:
const isEarlyDepletion = history.length > 0 && history[history.length - 1].quantity === -1
// ❌ Проверка на групповой истории

// Стало:
const productHistory = await this.getProductHistory(productId, familyId)
const isEarlyDepletion = productHistory.length > 0 && productHistory[productHistory.length - 1].quantity === -1
// ✅ Проверка на истории конкретного продукта
```

## Как проверить

1. Найдите тип продукта со статусом "В наличии" (зеленая карточка)
2. Нажмите оранжевую кнопку с треугольником
3. Статус должен измениться на "Заканчивается" (оранжевая карточка)
4. Кнопка должна смениться на зеленую (виртуальная покупка)

## Деплой

```bash
npm run build
git add -A
git commit -m "Fix: Early depletion for product groups"
git push origin main
```

Vercel автоматически задеплоит изменения.

