# –§–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ–∫–æ–≤ üöÄ

## –û–ø–∏—Å–∞–Ω–∏–µ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —Ñ–æ–Ω–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–µ–∫–æ–≤, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç:
- ‚úÖ –ó–∞–≥—Ä—É–∑–∏—Ç—å —á–µ–∫ –∏ —Å—Ä–∞–∑—É –∑–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –§—Ä–æ–Ω—Ç–µ–Ω–¥ ‚Üí Supabase Storage ‚Üí Vercel API ‚Üí Perplexity AI
                    ‚Üì                               ‚Üì
              Supabase DB ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –û–±—Ä–∞–±–æ—Ç–∫–∞ ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
              Realtime Updates ‚Üí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
```

### 2. –¢–∞–±–ª–∏—Ü–∞ pending_receipts

–û—á–µ—Ä–µ–¥—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–µ–∫–æ–≤:

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | int | ID –∑–∞–ø–∏—Å–∏ |
| family_id | int | ID —Å–µ–º—å–∏ |
| image_url | text | –ü—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é –≤ Storage |
| status | enum | pending / processing / completed / failed |
| error_message | text | –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ (–µ—Å–ª–∏ –µ—Å—Ç—å) |
| parsed_data | jsonb | –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ–∫–∞ |
| created_at | timestamp | –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è |
| processed_at | timestamp | –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ |
| attempts | int | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ |

### 3. Supabase Storage Bucket: "receipts"

–•—Ä–∞–Ω–∏–ª–∏—â–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ–∫–æ–≤:
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞: `{family_id}/{timestamp}.{ext}`
- –ü—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø –¥–ª—è —á—Ç–µ–Ω–∏—è (–¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ Perplexity API)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã

### –ó–∞–≥—Ä—É–∑–∫–∞ —á–µ–∫–∞

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ–∫–∞**
   - –í–∞–ª–∏–¥–∞—Ü–∏—è: —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –º–∞–∫—Å. 10MB
   
2. **–ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (1-2 —Å–µ–∫—É–Ω–¥—ã)**
   - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ Supabase Storage
   - –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `pending_receipts` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `pending`
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ "–ß–µ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω!"
   
3. **–¢—Ä–∏–≥–≥–µ—Ä —Ñ–æ–Ω–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏**
   - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è Vercel API endpoint `/api/process-receipt`
   - Fire-and-forget - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∂–¥–µ—Ç
   - –ú–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

### –§–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

1. **Vercel API –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å**
   - –ü–æ–ª—É—á–∞–µ—Ç ID pending receipt –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ `processing`
   
2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è**
   - –ü–æ–ª—É—á–∞–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–π URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ Storage
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Perplexity AI –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
   - –ü–∞—Ä—Å–∏—Ç JSON –æ—Ç–≤–µ—Ç
   
3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î**
   - –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ `receipts`
   - –°–æ–∑–¥–∞–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ `products`
   - –î–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ `product_history`
   - –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
   
4. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞**
   - –°—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `completed` –∏–ª–∏ `failed`
   - –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

### –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

1. **Realtime –ø–æ–¥–ø–∏—Å–∫–∞**
   - –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ `pending_receipts`
   - –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ UI –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   
2. **–°–ø–∏—Å–æ–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã—Ö —á–µ–∫–æ–≤**
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ —á–µ–∫–∏ —Å –∏—Ö —Å—Ç–∞—Ç—É—Å–∞–º–∏
   - –ò–∫–æ–Ω–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤: ‚è≥ pending, üîÑ processing, ‚úÖ completed, ‚ùå failed
   - –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö/–ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö —á–µ–∫–æ–≤

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î

```bash
# –í Supabase SQL Editor –≤—ã–ø–æ–ª–Ω–∏—Ç—å:
psql -f migration_add_pending_receipts.sql
```

### 2. –°–æ–∑–¥–∞—Ç—å Storage Bucket

–í Supabase Dashboard:

1. –ü–µ—Ä–µ–π—Ç–∏ –≤ **Storage** ‚Üí **Create bucket**
2. –ò–º—è: `receipts`
3. –ù–∞—Å—Ç—Ä–æ–π–∫–∏:
   - ‚úÖ Public bucket (–¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ URL)
   - File size limit: 10 MB
   
4. **–°–æ–∑–¥–∞—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞ (Policies):**

```sql
-- –ü–æ–ª–∏—Ç–∏–∫–∞ –¥–ª—è INSERT (–∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤)
CREATE POLICY "Users can upload receipts for their family"
ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id = 'receipts' AND
  auth.uid() IS NOT NULL
);

-- –ü–æ–ª–∏—Ç–∏–∫–∞ –¥–ª—è SELECT (—á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤)
CREATE POLICY "Anyone can view receipt images"
ON storage.objects FOR SELECT
USING (bucket_id = 'receipts');

-- –ü–æ–ª–∏—Ç–∏–∫–∞ –¥–ª—è DELETE (—É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤)
CREATE POLICY "Users can delete their family receipts"
ON storage.objects FOR DELETE
USING (
  bucket_id = 'receipts' AND
  auth.uid() IS NOT NULL
);
```

### 3. –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í `.env.local`:

```bash
VITE_SUPABASE_URL=your_supabase_url
VITE_SUPABASE_ANON_KEY=your_anon_key
PERPLEXITY_API_KEY=your_perplexity_key
```

–í Vercel (Settings ‚Üí Environment Variables):

```bash
VITE_SUPABASE_URL=your_supabase_url
VITE_SUPABASE_ANON_KEY=your_anon_key
PERPLEXITY_API_KEY=your_perplexity_key
```

### 4. –î–µ–ø–ª–æ–π –Ω–∞ Vercel

```bash
git add .
git commit -m "Add background receipt processing"
git push origin main
```

Vercel –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è.

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

1. **–ó–∞–≥—Ä—É–∑–∏—Ç—å —á–µ–∫**
   - –û—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫—É "–ß–µ–∫"
   - –ù–∞–∂–∞—Ç—å "–ö–∞–º–µ—Ä–∞" –∏–ª–∏ "–ì–∞–ª–µ—Ä–µ—è"
   - –í—ã–±—Ä–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ–∫–∞
   
2. **–ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞**
   - –£–≤–∏–¥–µ—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ "–ß–µ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω!"
   - –ú–æ–∂–Ω–æ —Å—Ä–∞–∑—É –∑–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
   
3. **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞**
   - –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è
   - –£–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã—Ö —á–µ–∫–æ–≤
   - –°—Ç–∞—Ç—É—Å—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
   
4. **–†–µ–∑—É–ª—å—Ç–∞—Ç**
   - –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ "–û–±—Ä–∞–±–æ—Ç–∞–Ω"
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

### API –º–µ—Ç–æ–¥—ã

```typescript
// –ó–∞–≥—Ä—É–∑–∏—Ç—å —á–µ–∫ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
const pendingReceipt = await SupabaseService.uploadReceiptForProcessing(
  familyId,
  imageFile
);

// –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ñ–æ–Ω–æ–≤—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É (fire-and-forget)
await SupabaseService.triggerReceiptProcessing(pendingReceipt.id);

// –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã—Ö —á–µ–∫–æ–≤
const receipts = await SupabaseService.getPendingReceipts(familyId);

// –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (Realtime)
const unsubscribe = SupabaseService.subscribeToPendingReceipts(
  familyId,
  (receipt) => {
    console.log('Receipt updated:', receipt);
  }
);

// –£–¥–∞–ª–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —á–µ–∫ –∏–∑ –æ—á–µ—Ä–µ–¥–∏
await SupabaseService.deletePendingReceipt(receiptId);
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### 1. –õ—É—á—à–∏–π UX
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∂–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É (1-2 —Å–µ–∫ –≤–º–µ—Å—Ç–æ 10-15 —Å–µ–∫)
- ‚úÖ –ú–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- ‚úÖ –ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–µ–∫–æ–≤ –ø–æ–¥—Ä—è–¥
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### 2. –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- ‚úÖ –ú–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫
- ‚úÖ Retry –º–µ—Ö–∞–Ω–∏–∑–º (—á–µ—Ä–µ–∑ attempts)

### 3. –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
- ‚úÖ Vercel Serverless Functions –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É—é—Ç—Å—è
- ‚úÖ –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç–æ–∫
- ‚úÖ Supabase Storage –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- ‚úÖ –í–∏–¥–Ω—ã –≤—Å–µ —á–µ–∫–∏ –≤ –æ—á–µ—Ä–µ–¥–∏
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ
- ‚úÖ –õ–æ–≥–∏ –æ—à–∏–±–æ–∫ –≤ Vercel –∏ Supabase

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ß–µ–∫ –∑–∞—Å—Ç—Ä—è–ª –≤ —Å—Ç–∞—Ç—É—Å–µ "pending"

**–ü—Ä–∏—á–∏–Ω–∞:** API endpoint –Ω–µ –±—ã–ª –≤—ã–∑–≤–∞–Ω –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤ Vercel Dashboard
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
3. –í—Ä—É—á–Ω—É—é –≤—ã–∑–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É:

```bash
curl -X POST https://your-app.vercel.app/api/process-receipt \
  -H "Content-Type: application/json" \
  -d '{"pendingReceiptId": 123}'
```

### –û—à–∏–±–∫–∞ "Storage bucket not found"

**–ü—Ä–∏—á–∏–Ω–∞:** Bucket "receipts" –Ω–µ —Å–æ–∑–¥–∞–Ω –≤ Supabase

**–†–µ—à–µ–Ω–∏–µ:**
1. –°–æ–∑–¥–∞—Ç—å bucket –≤ Supabase Dashboard ‚Üí Storage
2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞ (—Å–º. —Ä–∞–∑–¥–µ–ª "–ù–∞—Å—Ç—Ä–æ–π–∫–∞")

### –û—à–∏–±–∫–∞ Perplexity API

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á –∏–ª–∏ –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `PERPLEXITY_API_KEY` –≤ Vercel
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç—ã –Ω–∞ https://perplexity.ai/settings/api
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–º–∞–∫—Å. 10MB)

### Realtime –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç UI

**–ü—Ä–∏—á–∏–Ω–∞:** Realtime –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ Supabase

**–†–µ—à–µ–Ω–∏–µ:**
1. –í Supabase Dashboard ‚Üí Database ‚Üí Replication
2. –í–∫–ª—é—á–∏—Ç—å Realtime –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `pending_receipts`
3. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

## –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π:

```sql
-- –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ (—É–∂–µ –µ—Å—Ç—å –≤ –º–∏–≥—Ä–∞—Ü–∏–∏)
SELECT cleanup_old_pending_receipts();

-- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å pg_cron (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
SELECT cron.schedule(
  'cleanup-old-pending-receipts',
  '0 0 * * *', -- –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –ø–æ–ª–Ω–æ—á—å
  $$SELECT cleanup_old_pending_receipts()$$
);
```

### –†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞

```sql
-- –£–¥–∞–ª–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —á–µ–∫–∏ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
DELETE FROM pending_receipts
WHERE status IN ('completed', 'failed')
AND created_at < NOW() - INTERVAL '7 days';

-- –£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ Storage (–≤ Supabase Dashboard)
```

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- [ ] –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —á–µ–∫–æ–≤
- [ ] –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (VIP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- [ ] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –ø–æ—Ö–æ–∂–∏—Ö —á–µ–∫–æ–≤

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ —Ñ–æ–Ω–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–µ–∫–æ–≤ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å —á–µ–∫–∏ –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è, –∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.

