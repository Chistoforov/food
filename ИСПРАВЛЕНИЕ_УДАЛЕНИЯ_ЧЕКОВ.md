# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —É–¥–∞–ª–µ–Ω–∏—è —á–µ–∫–æ–≤

## –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —É–¥–∞–ª–∏—Ç—å —á–µ–∫ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –æ—à–∏–±–∫–∞:
```
function recalculate_monthly_stats(integer, text, integer) does not exist
```

## –ü—Ä–∏—á–∏–Ω–∞
–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Supabase –µ—Å—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é `recalculate_monthly_stats`, –Ω–æ —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ —Å–æ–∑–¥–∞–Ω–∞.

## –†–µ—à–µ–Ω–∏–µ

### –®–∞–≥ 1: –û—Ç–∫–ª—é—á–∏—Ç–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã (–ë–´–°–¢–†–û–ï –†–ï–®–ï–ù–ò–ï)
1. –û—Ç–∫—Ä–æ–π—Ç–µ [Supabase Dashboard](https://supabase.com/dashboard)
2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **SQL Editor**
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ SQL-–∫–æ–¥ –∏–∑ —Ñ–∞–π–ª–∞ `disable_recalculate_trigger.sql`

### –®–∞–≥ 2: –°–æ–∑–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –≤ Supabase (–ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–û–ï –†–ï–®–ï–ù–ò–ï)
–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–µ—Ä–µ—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:
1. –û—Ç–∫—Ä–æ–π—Ç–µ [Supabase Dashboard](https://supabase.com/dashboard)
2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **SQL Editor**
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ SQL-–∫–æ–¥ –∏–∑ —Ñ–∞–π–ª–∞ `create_simple_function.sql`

```sql
-- –°–æ–∑–¥–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ recalculate_monthly_stats
CREATE OR REPLACE FUNCTION recalculate_monthly_stats(p_family_id INTEGER, p_month VARCHAR(10), p_year INTEGER)
RETURNS VOID AS $$
DECLARE
    v_total_spent DECIMAL(10,2) := 0;
    v_total_calories INTEGER := 0;
    v_avg_calories_per_day INTEGER := 0;
    v_receipts_count INTEGER := 0;
    v_days_in_month INTEGER;
BEGIN
    -- –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –≤ –º–µ—Å—è—Ü–µ
    v_days_in_month := EXTRACT(DAY FROM (DATE_TRUNC('month', (p_year || '-' || p_month || '-01')::DATE) + INTERVAL '1 month - 1 day'));
    
    -- –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â—É—é —Å—É–º–º—É –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω—É—é –≤ –º–µ—Å—è—Ü–µ
    SELECT COALESCE(SUM(total_amount), 0)
    INTO v_total_spent
    FROM receipts
    WHERE family_id = p_family_id
        AND EXTRACT(YEAR FROM date) = p_year
        AND EXTRACT(MONTH FROM date) = p_month::INTEGER;
    
    -- –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–ª–æ—Ä–∏–π
    SELECT COALESCE(SUM(ph.quantity * p.calories), 0)
    INTO v_total_calories
    FROM product_history ph
    JOIN products p ON ph.product_id = p.id
    WHERE ph.family_id = p_family_id
        AND EXTRACT(YEAR FROM ph.date) = p_year
        AND EXTRACT(MONTH FROM ph.date) = p_month::INTEGER;
    
    -- –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–ª–æ—Ä–∏–π –≤ –¥–µ–Ω—å
    v_avg_calories_per_day := ROUND(v_total_calories / v_days_in_month);
    
    -- –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–∫–æ–≤
    SELECT COUNT(*)
    INTO v_receipts_count
    FROM receipts
    WHERE family_id = p_family_id
        AND EXTRACT(YEAR FROM date) = p_year
        AND EXTRACT(MONTH FROM date) = p_month::INTEGER;
    
    -- –û–±–Ω–æ–≤–ª—è–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    INSERT INTO monthly_stats (family_id, month, year, total_spent, total_calories, avg_calories_per_day, receipts_count)
    VALUES (p_family_id, p_year || '-' || p_month, p_year, v_total_spent, v_total_calories, v_avg_calories_per_day, v_receipts_count)
    ON CONFLICT (family_id, month, year)
    DO UPDATE SET
        total_spent = EXCLUDED.total_spent,
        total_calories = EXCLUDED.total_calories,
        avg_calories_per_day = EXCLUDED.avg_calories_per_day,
        receipts_count = EXCLUDED.receipts_count,
        updated_at = NOW();
END;
$$ language 'plpgsql';
```

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
–ï—Å–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ –µ—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–∞–∫–∂–µ —ç—Ç–æ—Ç SQL-–∫–æ–¥:

```sql
-- –í–∫–ª—é—á–∞–µ–º RLS –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
ALTER TABLE receipts ENABLE ROW LEVEL SECURITY;
ALTER TABLE product_history ENABLE ROW LEVEL SECURITY;
ALTER TABLE products ENABLE ROW LEVEL SECURITY;
ALTER TABLE families ENABLE ROW LEVEL SECURITY;
ALTER TABLE monthly_stats ENABLE ROW LEVEL SECURITY;

-- –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏
DROP POLICY IF EXISTS "Allow all operations on receipts" ON receipts;
DROP POLICY IF EXISTS "Allow all operations on product_history" ON product_history;
DROP POLICY IF EXISTS "Allow all operations on products" ON products;
DROP POLICY IF EXISTS "Allow all operations on families" ON families;
DROP POLICY IF EXISTS "Allow all operations on monthly_stats" ON monthly_stats;

-- –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏
CREATE POLICY "Allow all operations on receipts" ON receipts USING (true);
CREATE POLICY "Allow all operations on product_history" ON product_history USING (true);
CREATE POLICY "Allow all operations on products" ON products USING (true);
CREATE POLICY "Allow all operations on families" ON families USING (true);
CREATE POLICY "Allow all operations on monthly_stats" ON monthly_stats USING (true);
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL-–∫–æ–¥–∞:
1. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–¥–∞–ª–∏—Ç—å —á–µ–∫
3. –ß–µ–∫ –¥–æ–ª–∂–µ–Ω —É–¥–∞–ª–∏—Ç—å—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ
–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–∞–µ—Ç—Å—è, –º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –ø–µ—Ä–µ—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `src/services/supabaseService.ts`
2. –ù–∞–π–¥–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `deleteReceipt`
3. –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫–∏ —Å –ø–µ—Ä–µ—Å—á–µ—Ç–æ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —É–¥–∞–ª–µ–Ω–∏—è:
1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `test_delete_browser.html` –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ"
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —á–µ–∫ —É–¥–∞–ª—è–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

## –§–∞–π–ª—ã –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏
- `create_recalculate_function.sql` - SQL-–∫–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏
- `fix_rls_policies.sql` - SQL-–∫–æ–¥ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ RLS –ø–æ–ª–∏—Ç–∏–∫
- `test_delete_browser.html` - HTML-—Ñ–∞–π–ª –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è
