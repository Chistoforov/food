# Функция досрочного окончания продукта

## Что это?

Функция досрочного окончания позволяет отметить, что продукт закончился раньше, чем прогнозировалось системой. Это обратная операция от виртуальной покупки - вместо того чтобы продлить срок (когда продукт еще есть), мы сокращаем его (когда продукт закончился раньше).

## Как это работает?

### На главной странице

1. **Кнопка досрочного окончания** - появляется в правом нижнем углу карточек со статусом "В наличии" (ok)
   - Иконка: AlertTriangle (треугольник с восклицательным знаком)
   - Цвет: оранжевый (bg-orange-600)
   - При клике: анимация пульсации во время обработки
   - Имеет тень (shadow-sm) для лучшей видимости

2. **Расположение кнопок:**
   - Для продуктов со статусом "ok": кнопка досрочного окончания (оранжевая)
   - Для продуктов со статусом "ending-soon": кнопка виртуальной покупки (зеленая)

### Логика работы

**Пример с творогом:**

1. **До нажатия кнопки:**
   - Последняя покупка: 7 ноября
   - Avg_days: 5 дней
   - Predicted_end: 12 ноября
   - Статус: "в наличии" ✅

2. **После нажатия кнопки (10 ноября, продукт закончился раньше):**
   - Система добавляет запись о "досрочном окончании" с датой 10 ноября
   - Досрочное окончание имеет quantity=-1 (специальный маркер), price=0
   - Пересчитывается avg_days с учетом нового, более короткого интервала
   - Обновляется predicted_end
   - Статус меняется на "ending-soon" ⚠️

3. **Результат:**
   - Продукт закончился через 3 дня вместо прогнозируемых 5 дней
   - Новый avg_days будет учитывать более короткий интервал
   - При следующей покупке прогноз будет более точным (более консервативным)

### Технические детали

**Запись о досрочном окончании:**
- `quantity = -1` - специальный маркер "досрочное окончание" (отличается от виртуальной покупки quantity=0)
- `price = 0` - не влияет на статистику трат
- `unit_price = 0` - не влияет на цены
- `receipt_id = null` - не привязана к чеку
- `date = сегодня` - создает новую точку для расчета avg_days

**Пересчет:**
1. Добавляется запись в `product_history` с quantity=-1
2. Обновляется `last_purchase` продукта на сегодняшнюю дату
3. Вызывается `updateProductStats()` для пересчета avg_days и predicted_end
4. avg_days уменьшается, т.к. продукт закончился быстрее
5. Обновляется кэш статистики типов продуктов
6. Статус изменяется на "ending-soon" (продукт нужно купить снова)

**Отличия от виртуальной покупки:**

| Параметр | Виртуальная покупка | Досрочное окончание |
|----------|---------------------|---------------------|
| Назначение | Продукт еще есть | Продукт закончился раньше |
| quantity | 0 | -1 |
| Эффект на avg_days | Увеличивает | Уменьшает |
| Эффект на статус | ok → ok (продление) | ok → ending-soon |
| Кнопка | Зеленая (RefreshCw) | Оранжевая (AlertTriangle) |
| Когда показывается | ending-soon | ok |

## Файлы

### `/src/services/supabaseService.ts`
- Метод `markAsDepletedEarly(productId, familyId)` - отметка одного продукта как досрочно закончившегося
- Метод `markTypeAsDepletedEarly(productType, familyId)` - отметка всех продуктов типа как досрочно закончившихся (получает продукты напрямую из БД)

### `/src/GroceryTrackerApp.tsx`
- Состояние `earlyDepletionLoading` - отслеживание загрузки
- Обработчик `handleEarlyDepletion(productType)` - обработка клика (использует `markTypeAsDepletedEarly`)
- Кнопка с иконкой AlertTriangle на карточках с ok

## Использование

1. Откройте главную страницу
2. Найдите карточку продукта со статусом "В наличии" (зеленая)
3. Нажмите кнопку с треугольником и восклицательным знаком в правом нижнем углу
4. Дождитесь анимации загрузки
5. Статус продукта обновится на "Заканчивается"
6. При следующей покупке прогноз будет более консервативным

## Преимущества подхода

- ✅ Естественно вписывается в существующую логику
- ✅ История покупок сохраняется
- ✅ Не влияет на статистику расхода и трат
- ✅ Автоматически корректирует avg_days в сторону уменьшения
- ✅ Работает для всех продуктов типа одновременно
- ✅ Не требует изменений в схеме базы данных
- ✅ Дополняет виртуальную покупку (работают в обе стороны)

## Сценарии использования

1. **Гости съели больше обычного:**
   - Купили продукт 5 дней назад
   - Обычно хватает на 7 дней
   - Закончился на 5-й день
   - Нажимаем кнопку досрочного окончания
   - Система скорректирует прогноз

2. **Испортился продукт:**
   - Купили молоко неделю назад
   - Обычно хватает на 10 дней
   - Молоко испортилось на 7-й день
   - Отмечаем досрочное окончание
   - Система учтет это в будущих прогнозах

3. **Изменились привычки потребления:**
   - Раньше хлеб хватал на 3 дня
   - Теперь стали есть больше
   - Хлеб заканчивается через 2 дня
   - Отмечаем досрочное окончание несколько раз
   - avg_days корректируется на новую частоту

## Будущие улучшения

- Добавить аналитику по досрочным окончаниям (сколько раз корректировался каждый продукт)
- Возможность отмены досрочного окончания
- История корректировок в интерфейсе
- Показывать разницу между прогнозом и фактическим окончанием
- Уведомления о систематических досрочных окончаниях (возможно, нужно чаще покупать)

## Взаимодействие с виртуальной покупкой

Две функции работают как противовесы:

- **Виртуальная покупка (зеленая):** "Продукт еще есть, не торопитесь покупать" → увеличивает avg_days
- **Досрочное окончание (оранжевая):** "Продукт закончился раньше, нужно покупать чаще" → уменьшает avg_days

Вместе они помогают системе адаптироваться к реальным условиям потребления и давать более точные прогнозы.









