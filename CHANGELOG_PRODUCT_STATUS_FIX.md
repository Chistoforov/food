# Changelog: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤

**–î–∞—Ç–∞**: 4 –Ω–æ—è–±—Ä—è 2025  
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–æ–¥—É–∫—Ç—ã, –∫—É–ø–ª–µ–Ω–Ω—ã–µ —Å–µ–≥–æ–¥–Ω—è, —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∞–ª–∏ —Å—Ç–∞—Ç—É—Å "–∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è"  
**–ü—Ä–∏—á–∏–Ω–∞**: –ú–∞–ª—ã–π —Å—Ä–µ–¥–Ω–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø–æ–∫—É–ø–∫–∞–º–∏ (2-3 –¥–Ω—è) –ø–æ–ø–∞–¥–∞–ª –≤ –ø–æ—Ä–æ–≥ "ending-soon" (‚â§ 2 –¥–Ω–µ–π)

## –ò–∑–º–µ–Ω–µ–Ω–∏—è

### ‚úÖ –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ

1. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Å—Ç–∞—Ç—É—Å –ö–∏–Ω–¥–µ—Ä–∞**
   - –ë—ã–ª–æ: `ending-soon` ‚ùå
   - –°—Ç–∞–ª–æ: `ok` ‚úÖ
   - –ü—Ä–æ–¥—É–∫—Ç –∫—É–ø–ª–µ–Ω —Å–µ–≥–æ–¥–Ω—è (4 –Ω–æ—è–±—Ä—è 2025)

### üìù –ò–∑–º–µ–Ω–µ–Ω –∫–æ–¥ (—Ç—Ä–µ–±—É–µ—Ç –¥–µ–ø–ª–æ—è)

#### Frontend
**–§–∞–π–ª**: `src/services/supabaseService.ts`

```diff
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
  const today = new Date()
+ today.setHours(0, 0, 0, 0)
+ 
+ const lastPurchaseDate = new Date(lastPurchase)
+ lastPurchaseDate.setHours(0, 0, 0, 0)
+ 
+ const daysSincePurchase = Math.floor((today.getTime() - lastPurchaseDate.getTime()) / (1000 * 60 * 60 * 24))
  const daysUntilEnd = Math.floor((predictedEnd.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))
  
  let status: 'ending-soon' | 'ok' | 'calculating' = 'ok'
- if (daysUntilEnd <= 2) {
+ 
+ // –ï—Å–ª–∏ –ø—Ä–æ–¥—É–∫—Ç –∫—É–ø–ª–µ–Ω –Ω–µ–¥–∞–≤–Ω–æ, —Å—Ç–∞—Ç—É—Å –≤—Å–µ–≥–¥–∞ "ok"
+ if (daysSincePurchase < 2) {
+   status = 'ok'
+ } else if (daysUntilEnd <= 2) {
    status = 'ending-soon'
  }
```

#### Backend
**–§–∞–π–ª**: `api/process-receipt.js`

```diff
+ // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ID –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
+ const affectedProductIds = [];

  // Process each item
  for (const item of items) {
    ...
+   
+   // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
+   affectedProductIds.push(product.id);
  }

+ // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è –≤—Å–µ—Ö –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
+ for (const productId of affectedProductIds) {
+   await supabase.rpc('update_product_analytics', {
+     p_product_id: productId,
+     p_family_id: familyId
+   });
+ }
```

### üóÑÔ∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–º–µ–Ω–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏—é

**–§–∞–π–ª**: `migration_update_product_stats_function.sql`

–°–æ–∑–¥–∞–Ω–∞ RPC —Ñ—É–Ω–∫—Ü–∏—è `update_product_analytics()` –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤.

**–ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å**: —Å–º. `APPLY_MIGRATION_PRODUCT_STATUS.md`

## –†–µ–∑—É–ª—å—Ç–∞—Ç

### –ë—ã–ª–æ
```
–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Üí –û–±–∑–æ—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –∫–∏–Ω–¥–µ—Ä              ‚îÇ
‚îÇ –í—Å–µ–≥–æ: 1            ‚îÇ
‚îÇ üî¥ –ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è: 1 ‚îÇ ‚Üê –ü–†–û–ë–õ–ï–ú–ê
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –°—Ç–∞–ª–æ
```
–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Üí –û–±–∑–æ—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –∫–∏–Ω–¥–µ—Ä              ‚îÇ
‚îÇ –í—Å–µ–≥–æ: 1            ‚îÇ
‚îÇ üü¢ –í –Ω–∞–ª–∏—á–∏–∏: 1     ‚îÇ ‚Üê –ò–°–ü–†–ê–í–õ–ï–ù–û
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü—Ä–æ–¥—É–∫—Ç –∫—É–ø–ª–µ–Ω —Å–µ–≥–æ–¥–Ω—è
- **–û–∂–∏–¥–∞–µ—Ç—Å—è**: —Å—Ç–∞—Ç—É—Å = `ok` ‚úÖ
- **–¢–µ—Å—Ç**: –ö—É–ø–∏—Ç–µ –ª—é–±–æ–π –ø—Ä–æ–¥—É–∫—Ç —Å–µ–≥–æ–¥–Ω—è ‚Üí –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –Ω–∞ –≥–ª–∞–≤–Ω–æ–π

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü—Ä–æ–¥—É–∫—Ç –∫—É–ø–ª–µ–Ω –≤—á–µ—Ä–∞
- **–û–∂–∏–¥–∞–µ—Ç—Å—è**: —Å—Ç–∞—Ç—É—Å = `ok` ‚úÖ
- **–¢–µ—Å—Ç**: –ü—Ä–æ–¥—É–∫—Ç —Å –¥–∞—Ç–æ–π –ø–æ–∫—É–ø–∫–∏ = –≤—á–µ—Ä–∞ ‚Üí —Å—Ç–∞—Ç—É—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `ok`

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü—Ä–æ–¥—É–∫—Ç –∫—É–ø–ª–µ–Ω 3+ –¥–Ω–µ–π –Ω–∞–∑–∞–¥
- **–û–∂–∏–¥–∞–µ—Ç—Å—è**: —Å—Ç–∞—Ç—É—Å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ –ø—Ä–æ–≥–Ω–æ–∑—É
  - –ï—Å–ª–∏ –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è ‚â§ 2 –¥–Ω–µ–π ‚Üí `ending-soon`
  - –ò–Ω–∞—á–µ ‚Üí `ok`

## –ß—Ç–æ –¥–∞–ª—å—à–µ?

1. ‚úÖ **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** - –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ö–∏–Ω–¥–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–í –Ω–∞–ª–∏—á–∏–∏"

2. üìù **–ü—Ä–∏–º–µ–Ω–∏—Ç–µ SQL –º–∏–≥—Ä–∞—Ü–∏—é** (–∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –≤—Ä–µ–º—è):
   - –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard ‚Üí SQL Editor
   - –í—ã–ø–æ–ª–Ω–∏—Ç–µ `migration_update_product_stats_function.sql`
   - –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á–µ—Ç —Å—Ç–∞—Ç—É—Å–æ–≤ –¥–ª—è –±—É–¥—É—â–∏—Ö —á–µ–∫–æ–≤

3. üöÄ **–ó–∞–¥–µ–ø–ª–æ–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**:
   ```bash
   git add .
   git commit -m "fix: –ø—Ä–æ–¥—É–∫—Ç—ã, –∫—É–ø–ª–µ–Ω–Ω—ã–µ –Ω–µ–¥–∞–≤–Ω–æ, —Ç–µ–ø–µ—Ä—å –Ω–µ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ '–∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è'"
   git push
   ```

## –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã:
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã
- –°—Ç–∞—Ä—ã–µ —á–µ–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–µ—Å—á–µ—Ç–µ —Å—Ç–∞—Ç—É—Å–æ–≤

## –ó–∞–º–µ—Ç–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

### –ü–æ—á–µ–º—É –ø–æ—Ä–æ–≥ = 2 –¥–Ω—è?

–ï—Å–ª–∏ –ø—Ä–æ–¥—É–∫—Ç –∫—É–ø–ª–µ–Ω **–º–µ–Ω–µ–µ 2 –¥–Ω–µ–π –Ω–∞–∑–∞–¥**, –æ–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å "–∑–∞–∫–∞–Ω—á–∏–≤–∞—é—â–∏–º—Å—è", –ø–æ—Ç–æ–º—É —á—Ç–æ:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–æ–ª—å–∫–æ —á—Ç–æ –µ–≥–æ –∫—É–ø–∏–ª
- –õ–æ–≥–∏—á–Ω–æ, —á—Ç–æ –∑–∞–ø–∞—Å –µ—Å—Ç—å
- –î–∞–∂–µ –µ—Å–ª–∏ —Å—Ä–µ–¥–Ω–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª = 2-3 –¥–Ω—è, –Ω—É–∂–Ω–æ –≤—Ä–µ–º—è –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ 2, –∞ –Ω–µ 1 –¥–µ–Ω—å?

- **1 –¥–µ–Ω—å**: —Å–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–æ (–ø—Ä–æ–¥—É–∫—Ç, –∫—É–ø–ª–µ–Ω–Ω—ã–π –≤—á–µ—Ä–∞, –º–æ–∂–µ—Ç –±—ã—Ç—å ending-soon)
- **2 –¥–Ω—è**: —Ä–∞–∑—É–º–Ω—ã–π –±–∞–ª–∞–Ω—Å (–ø—Ä–æ–¥—É–∫—Ç—ã –æ–±—ã—á–Ω–æ –Ω–µ –∫–æ–Ω—á–∞—é—Ç—Å—è –∑–∞ 1-2 –¥–Ω—è)
- **3+ –¥–Ω—è**: —Å–ª–∏—à–∫–æ–º –º—è–≥–∫–æ (–Ω–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å ending-soon –≤–æ–≤—Ä–µ–º—è)

---

**–ê–≤—Ç–æ—Ä**: AI Assistant  
**–î–∞—Ç–∞**: 2025-11-04  
**–í–µ—Ä—Å–∏—è**: 1.0.0









