# üöÄ –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è —á–µ–∫–æ–≤

## ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —á–µ–∫–∞ –æ—à–∏–±–∫–∞: `invalid input syntax for type integer: "2025-10"`

## ‚úÖ –†–µ—à–µ–Ω–∏–µ (2 –º–∏–Ω—É—Ç—ã)

### 1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard
https://supabase.com/dashboard

### 2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ SQL Editor
Dashboard ‚Üí SQL Editor ‚Üí New Query

### 3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ—Ç SQL:

```sql
-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —á–µ–∫–æ–≤
CREATE OR REPLACE FUNCTION recalculate_stats_after_receipt_delete()
RETURNS TRIGGER AS $$
DECLARE
    v_year INTEGER;
    v_month VARCHAR(10);
BEGIN
    v_year := EXTRACT(YEAR FROM OLD.date);
    v_month := LPAD(EXTRACT(MONTH FROM OLD.date)::TEXT, 2, '0');
    
    -- –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø–µ—Ä–µ–¥–∞–µ–º v_month –≤–º–µ—Å—Ç–æ v_year || '-' || v_month
    PERFORM recalculate_monthly_stats(OLD.family_id, v_month, v_year);
    
    RETURN OLD;
END;
$$ LANGUAGE plpgsql;

-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
CREATE OR REPLACE FUNCTION recalculate_stats_on_history_delete()
RETURNS TRIGGER AS $$
DECLARE
    v_family_id INTEGER;
    v_month VARCHAR(10);
    v_year INTEGER;
BEGIN
    v_family_id := OLD.family_id;
    v_year := EXTRACT(YEAR FROM OLD.date);
    v_month := LPAD(EXTRACT(MONTH FROM OLD.date)::TEXT, 2, '0');
    
    -- –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø–µ—Ä–µ–¥–∞–µ–º v_month –≤–º–µ—Å—Ç–æ v_year || '-' || v_month
    PERFORM recalculate_monthly_stats(v_family_id, v_month, v_year);
    
    RETURN OLD;
END;
$$ LANGUAGE plpgsql;
```

### 4. –ù–∞–∂–º–∏—Ç–µ "Run" –∏–ª–∏ Ctrl+Enter

### 5. –ì–æ—Ç–æ–≤–æ! ‚úÖ

–¢–µ–ø–µ—Ä—å –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —É–¥–∞–ª–∏—Ç—å —á–µ–∫ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ - –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –æ—à–∏–±–æ–∫!

---

## üìÑ –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
–°–º–æ—Ç—Ä–∏—Ç–µ `–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï_–£–î–ê–õ–ï–ù–ò–Ø_–ß–ï–ö–û–í_BUG.md` –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π

