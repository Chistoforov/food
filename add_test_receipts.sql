-- Скрипт для добавления 5 тестовых чеков с пересекающимися продуктами
-- Это создаст разнообразную статистику для тестирования

-- Добавляем новые продукты с калориями и ценами
INSERT INTO products (name, original_name, last_purchase, avg_days, predicted_end, status, calories, price, purchase_count, family_id) VALUES
-- Основные продукты, которые будут встречаться в разных чеках
('Яблоки', 'Яблоки красные', '2024-11-01', 5, '2024-11-06', 'ending-soon', 52, 2.50, 3, 1),
('Бананы', 'Бананы спелые', '2024-11-01', 4, '2024-11-05', 'ending-soon', 89, 1.80, 4, 1),
('Морковь', 'Морковь свежая', '2024-11-01', 7, '2024-11-08', 'ok', 41, 1.20, 2, 1),
('Картофель', 'Картофель молодой', '2024-11-01', 10, '2024-11-11', 'ok', 77, 1.50, 2, 1),
('Лук', 'Лук репчатый', '2024-11-01', 14, '2024-11-15', 'ok', 40, 0.80, 1, 1),
('Помидоры', 'Помидоры черри', '2024-11-01', 6, '2024-11-07', 'ending-soon', 18, 3.20, 3, 1),
('Огурцы', 'Огурцы тепличные', '2024-11-01', 5, '2024-11-06', 'ending-soon', 16, 2.80, 2, 1),
('Сыр', 'Сыр твердый', '2024-11-01', 8, '2024-11-09', 'ok', 356, 4.50, 2, 1),
('Йогурт', 'Йогурт натуральный', '2024-11-01', 3, '2024-11-04', 'ending-soon', 59, 1.20, 5, 1),
('Кефир', 'Кефир 1%', '2024-11-01', 4, '2024-11-05', 'ending-soon', 40, 1.00, 4, 1),
('Курица', 'Курица целая', '2024-11-01', 12, '2024-11-13', 'ok', 165, 6.50, 1, 1),
('Говядина', 'Говядина вырезка', '2024-11-01', 15, '2024-11-16', 'ok', 250, 12.00, 1, 1),
('Рыба', 'Лосось свежий', '2024-11-01', 10, '2024-11-11', 'ok', 208, 15.00, 1, 1),
('Яйца', 'Яйца куриные', '2024-11-01', 7, '2024-11-08', 'ok', 155, 2.80, 2, 1),
('Масло', 'Масло сливочное', '2024-11-01', 14, '2024-11-15', 'ok', 717, 3.50, 1, 1);

-- Добавляем 5 тестовых чеков с пересекающимися продуктами
INSERT INTO receipts (date, items_count, total_amount, status, family_id) VALUES
-- Чек 1: Овощи и молочные продукты (2024-11-01)
('2024-11-01', 6, 15.20, 'processed', 1),
-- Чек 2: Фрукты и овощи (2024-10-28)
('2024-10-28', 5, 12.50, 'processed', 1),
-- Чек 3: Мясо и овощи (2024-10-25)
('2024-10-25', 4, 22.30, 'processed', 1),
-- Чек 4: Молочные продукты и яйца (2024-10-22)
('2024-10-22', 5, 8.70, 'processed', 1),
-- Чек 5: Смешанный чек (2024-10-19)
('2024-10-19', 7, 28.40, 'processed', 1);

-- Добавляем историю покупок для каждого продукта
-- Чек 1 (2024-11-01): Овощи и молочные продукты
INSERT INTO product_history (product_id, date, quantity, price, unit_price, family_id) VALUES
-- Яблоки (ID: 5)
(5, '2024-11-01', 2, 5.00, 2.50, 1),
-- Бананы (ID: 6)
(6, '2024-11-01', 3, 5.40, 1.80, 1),
-- Морковь (ID: 7)
(7, '2024-11-01', 1, 1.20, 1.20, 1),
-- Йогурт (ID: 13)
(13, '2024-11-01', 2, 2.40, 1.20, 1),
-- Кефир (ID: 14)
(14, '2024-11-01', 1, 1.00, 1.00, 1),
-- Яйца (ID: 18)
(18, '2024-11-01', 1, 2.80, 2.80, 1);

-- Чек 2 (2024-10-28): Фрукты и овощи
INSERT INTO product_history (product_id, date, quantity, price, unit_price, family_id) VALUES
-- Яблоки (ID: 5) - пересечение с чеком 1
(5, '2024-10-28', 1, 2.50, 2.50, 1),
-- Бананы (ID: 6) - пересечение с чеком 1
(6, '2024-10-28', 2, 3.60, 1.80, 1),
-- Помидоры (ID: 10)
(10, '2024-10-28', 1, 3.20, 3.20, 1),
-- Огурцы (ID: 11)
(11, '2024-10-28', 1, 2.80, 2.80, 1),
-- Картофель (ID: 8)
(8, '2024-10-28', 1, 1.50, 1.50, 1);

-- Чек 3 (2024-10-25): Мясо и овощи
INSERT INTO product_history (product_id, date, quantity, price, unit_price, family_id) VALUES
-- Курица (ID: 15)
(15, '2024-10-25', 1, 6.50, 6.50, 1),
-- Морковь (ID: 7) - пересечение с чеком 1
(7, '2024-10-25', 2, 2.40, 1.20, 1),
-- Картофель (ID: 8) - пересечение с чеком 2
(8, '2024-10-25', 3, 4.50, 1.50, 1),
-- Лук (ID: 9)
(9, '2024-10-25', 1, 0.80, 0.80, 1);

-- Чек 4 (2024-10-22): Молочные продукты и яйца
INSERT INTO product_history (product_id, date, quantity, price, unit_price, family_id) VALUES
-- Сыр (ID: 12)
(12, '2024-10-22', 1, 4.50, 4.50, 1),
-- Йогурт (ID: 13) - пересечение с чеком 1
(13, '2024-10-22', 3, 3.60, 1.20, 1),
-- Кефир (ID: 14) - пересечение с чеком 1
(14, '2024-10-22', 2, 2.00, 1.00, 1),
-- Яйца (ID: 18) - пересечение с чеком 1
(18, '2024-10-22', 1, 2.80, 2.80, 1),
-- Масло (ID: 19)
(19, '2024-10-22', 1, 3.50, 3.50, 1);

-- Чек 5 (2024-10-19): Смешанный чек
INSERT INTO product_history (product_id, date, quantity, price, unit_price, family_id) VALUES
-- Говядина (ID: 16)
(16, '2024-10-19', 1, 12.00, 12.00, 1),
-- Рыба (ID: 17)
(17, '2024-10-19', 1, 15.00, 15.00, 1),
-- Помидоры (ID: 10) - пересечение с чеком 2
(10, '2024-10-19', 2, 6.40, 3.20, 1),
-- Огурцы (ID: 11) - пересечение с чеком 2
(11, '2024-10-19', 1, 2.80, 2.80, 1),
-- Лук (ID: 9) - пересечение с чеком 3
(9, '2024-10-19', 1, 0.80, 0.80, 1),
-- Сыр (ID: 12) - пересечение с чеком 4
(12, '2024-10-19', 1, 4.50, 4.50, 1),
-- Масло (ID: 19) - пересечение с чеком 4
(19, '2024-10-19', 1, 3.50, 3.50, 1);

-- Обновляем статистику продуктов после добавления истории
UPDATE products SET 
  purchase_count = (
    SELECT COUNT(*) FROM product_history 
    WHERE product_id = products.id AND family_id = products.family_id
  ),
  last_purchase = (
    SELECT MAX(date) FROM product_history 
    WHERE product_id = products.id AND family_id = products.family_id
  )
WHERE family_id = 1;

-- Пересчитываем месячную статистику для октября 2024
SELECT recalculate_monthly_stats(1, '2024-10', 2024);

-- Пересчитываем месячную статистику для ноября 2024
SELECT recalculate_monthly_stats(1, '2024-11', 2024);

-- Показываем итоговую статистику
SELECT 
  'Октябрь 2024' as month,
  total_spent,
  total_calories,
  avg_calories_per_day,
  receipts_count
FROM monthly_stats 
WHERE family_id = 1 AND month = '2024-10' AND year = 2024

UNION ALL

SELECT 
  'Ноябрь 2024' as month,
  total_spent,
  total_calories,
  avg_calories_per_day,
  receipts_count
FROM monthly_stats 
WHERE family_id = 1 AND month = '2024-11' AND year = 2024;
