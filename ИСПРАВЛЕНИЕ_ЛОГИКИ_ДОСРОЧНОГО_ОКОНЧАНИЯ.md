# Исправление: Логика досрочного окончания для типов продуктов

**Дата:** 15 ноября 2025  
**Статус:** ✅ Исправлено

## Проблема

При нажатии кнопки "Продукт закончился раньше" для типа продукта (например, "креветки"):

1. ✅ Все продукты этого типа успешно отмечались как досрочно закончившиеся
2. ✅ В историю добавлялись записи с `quantity=-1`
3. ✅ `last_purchase` обновлялся на сегодня
4. ✅ `avg_days` пересчитывался (уменьшался)
5. ❌ **НО статус продуктов оставался `'ok'` (В наличии) вместо `'ending-soon'` (Заканчивается)**

## Причина

Проблема была в логике функции `calculateProductStats()` в файле `src/services/supabaseService.ts`.

### Старая логика (НЕПРАВИЛЬНАЯ):

```typescript
if (daysSincePurchase < 2 && !isEarlyDepletion) {
  status = 'ok'
} else if (daysUntilEnd <= 2) {
  status = 'ending-soon'
}
```

### Что происходило:

1. Продукт отмечался как досрочно закончившийся
2. `last_purchase` = сегодня (15 ноября)
3. `avg_days` уменьшался, например, с 10 до 3 дней
4. `predicted_end` = сегодня + avg_days = 15 ноября + 3 дня = **18 ноября**
5. `daysUntilEnd` = 3 дня (**> 2 дней!**)
6. Условие `daysUntilEnd <= 2` не выполнялось
7. ❌ Статус оставался `'ok'` по умолчанию

**Проблема:** Даже если продукт закончился СЕГОДНЯ, `predicted_end` всегда в будущем, потому что рассчитывается как `today + avg_days`.

## Решение

Изменена логика проверки статуса - **досрочное окончание теперь имеет наивысший приоритет**.

### Новая логика (ПРАВИЛЬНАЯ):

```typescript
// ПРИОРИТЕТ 1: Если последняя запись - досрочное окончание, продукт УЖЕ закончился
if (isEarlyDepletion) {
  status = 'ending-soon'
}
// ПРИОРИТЕТ 2: Если продукт куплен недавно (меньше 2 дней назад)
else if (daysSincePurchase < 2) {
  status = 'ok'
}
// ПРИОРИТЕТ 3: Проверяем прогноз окончания
else if (daysUntilEnd <= 2) {
  status = 'ending-soon'
}
```

### Приоритеты статусов:

1. **ПРИОРИТЕТ 1 (САМЫЙ ВЫСОКИЙ):** Досрочное окончание (`quantity=-1`) → статус **ВСЕГДА** `'ending-soon'`
2. **ПРИОРИТЕТ 2:** Недавняя покупка (< 2 дней) → статус `'ok'` (гарантия 2 дней)
3. **ПРИОРИТЕТ 3:** Прогноз окончания (≤ 2 дней) → статус `'ending-soon'`

## Что теперь работает

### Обычная покупка (из чека)
- Последняя запись: `quantity > 0`
- `isEarlyDepletion = false`
- **Результат:** Гарантия минимум 2 дня статуса `'ok'` после покупки

### Досрочное окончание (кнопка)
- Последняя запись: `quantity = -1`
- `isEarlyDepletion = true`
- **Результат:** Статус **СРАЗУ** меняется на `'ending-soon'`, независимо от:
  - Даты покупки
  - Значения `avg_days`
  - Значения `predicted_end`
  - Значения `daysUntilEnd`

### Досрочное окончание для ТИПА продукта
Кнопка работает **для всей категории**:

1. Пользователь нажимает кнопку на карточке типа (например, "креветки")
2. Система находит **ВСЕ** продукты этого типа из БД
3. Для **КАЖДОГО** продукта:
   - Добавляется запись в историю с `quantity=-1`
   - Обновляется `last_purchase` на сегодня
   - Пересчитывается статистика
   - **Статус меняется на `'ending-soon'`**
4. Пересчитывается кэш статистики типов
5. Интерфейс обновляется

## Файлы

### Изменены:
- ✅ `src/services/supabaseService.ts` - функция `calculateProductStats()` (строки 335-359)

### Добавлены:
- ✅ `ИСПРАВЛЕНИЕ_ЛОГИКИ_ДОСРОЧНОГО_ОКОНЧАНИЯ.md` - эта документация

## Как проверить

1. Откройте главную страницу
2. Найдите карточку типа продукта со статусом "В наличии" (зеленая рамка)
3. Нажмите кнопку с оранжевым треугольником (досрочное окончание)
4. **Результат:** Карточка должна **сразу** поменять цвет на оранжевый ("Заканчивается")
5. Все продукты этого типа должны получить статус "Заканчивается"

## Связанные документы

- `EARLY_DEPLETION_FEATURE.md` - описание функции досрочного окончания
- `FIX_EARLY_DEPLETION_BUTTON.md` - предыдущее исправление (правило 2-х дней)
- `FIX_EARLY_DEPLETION_GROUP_HISTORY.md` - исправление для групповой истории
- `FIX_EARLY_DEPLETION_CACHE.md` - исправление кэша статистики типов

