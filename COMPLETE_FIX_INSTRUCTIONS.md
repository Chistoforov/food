# ‚úÖ –ü–æ–ª–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤

## üéØ –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–æ–¥—É–∫—Ç—ã, –∫—É–ø–ª–µ–Ω–Ω—ã–µ —Å–µ–≥–æ–¥–Ω—è, –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ —Å—Ç–∞—Ç—É—Å "ending-soon" –≤–º–µ—Å—Ç–æ "ok"

## üîß –†–µ—à–µ–Ω–∏–µ (—É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ —á–∞—Å—Ç–∏—á–Ω–æ)

### ‚úÖ –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω—ë–Ω –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä
–§–∞–π–ª: `FIX_ALL_STATUSES.sql` - **–£–ñ–ï –í–´–ü–û–õ–ù–ï–ù–û**
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `recalculate_single_product_type_stats`
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `trigger_recalculate_product_type_stats`

### ‚úÖ –®–∞–≥ 2: –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–µ–∫—É—â–∏–µ —Å—Ç–∞—Ç—É—Å—ã
–§–∞–π–ª: `UPDATE_PRODUCT_STATUSES.sql` - **–£–ñ–ï –í–´–ü–û–õ–ù–ï–ù–û**
- –°–æ–∫ –∏ –π–æ–≥—É—Ä—Ç —Ç–µ–ø–µ—Ä—å –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å "ok"

### ‚ö†Ô∏è –®–∞–≥ 3: –ù–£–ñ–ù–û –ü–†–ò–ú–ï–ù–ò–¢–¨ - –£–ª—É—á—à–µ–Ω–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä —Å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
–§–∞–π–ª: `IMPROVED_TRIGGER_WITH_AUTO_UPDATE.sql`

**–í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –≤ Supabase!**

–≠—Ç–æ—Ç —É–ª—É—á—à–µ–Ω–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä –±—É–¥–µ—Ç:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å –∫—ç—à `product_type_stats` –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏/–∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
- ‚úÖ **–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –æ–±–Ω–æ–≤–ª—è—Ç—å —Å—Ç–∞—Ç—É—Å—ã –≤—Å–µ—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤** —ç—Ç–æ–≥–æ —Ç–∏–ø–∞

### ‚ö†Ô∏è –®–∞–≥ 4: –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CRON –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
–§–∞–π–ª: `SETUP_DAILY_STATUS_UPDATE_CRON.sql`

**–í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å —Ç–µ—á–µ–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏**

CRON job –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –∫–∞–∂–¥—É—é –Ω–æ—á—å –≤ 00:00 –∏:
- –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å—ã –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
- –û–±–Ω–æ–≤–ª—è—Ç—å —Å—Ç–∞—Ç—É—Å—ã –≤—Å–µ—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ `pg_cron` (–æ–±—ã—á–Ω–æ –≤–∫–ª—é—á–µ–Ω–æ –≤ Supabase)

## üìã –ö–æ–≥–¥–∞ —Å—Ç–∞—Ç—É—Å—ã –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞ (–®–∞–≥ 3):

‚úÖ **–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —á–µ–∫–∞:**
- –ö–æ–≥–¥–∞ API –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —á–µ–∫ –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ–¥—É–∫—Ç—ã
- –¢—Ä–∏–≥–≥–µ—Ä —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –°—Ç–∞—Ç—É—Å—ã –æ–±–Ω–æ–≤—è—Ç—Å—è —Å—Ä–∞–∑—É

‚úÖ **–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞:**
- –õ—é–±–æ–µ UPDATE –≤ —Ç–∞–±–ª–∏—Ü–µ `products`
- –¢—Ä–∏–≥–≥–µ—Ä –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ –ø—Ä–æ–¥—É–∫—Ç–∞
- –û–±–Ω–æ–≤–∏—Ç —Å—Ç–∞—Ç—É—Å—ã –≤—Å–µ—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —ç—Ç–æ–≥–æ —Ç–∏–ø–∞

### –ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CRON (–®–∞–≥ 4):

‚úÖ **–ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –ø–æ–ª–Ω–æ—á—å:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã
- –£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–æ—à–µ–¥—à–∏–µ –¥–Ω–∏
- –ü—Ä–æ–¥—É–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è, –ø–æ–ª—É—á–∞—Ç —Å—Ç–∞—Ç—É—Å "ending-soon"

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞, –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–µ —Å—Ç–∞—Ç—É—Å—ã
SELECT 
  name, product_type, status, last_purchase,
  CURRENT_DATE - last_purchase AS days_ago
FROM products
WHERE family_id = 1
ORDER BY last_purchase DESC
LIMIT 10;

-- –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ (—Ç—Ä–∏–≥–≥–µ—Ä –¥–æ–ª–∂–µ–Ω —Å—Ä–∞–±–æ—Ç–∞—Ç—å)
UPDATE products
SET updated_at = NOW()
WHERE family_id = 1 AND product_type = '—Å–æ–∫'
LIMIT 1;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å—Ç–∞—Ç—É—Å—ã –æ–±–Ω–æ–≤–∏–ª–∏—Å—å
SELECT 
  name, product_type, status, last_purchase,
  CURRENT_DATE - last_purchase AS days_ago
FROM products
WHERE family_id = 1 AND product_type = '—Å–æ–∫';
```

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

### `UPDATE_ALL_PRODUCT_STATUSES.sql`
–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –≤—Å–µ—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Å–µ–º–µ–π.
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Ä–∞–∑–æ–≤–æ –æ–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã.

## ‚ùì FAQ

**Q: –ù—É–∂–Ω–æ –ª–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–π —Ä–∞–∑?**
A: –ù–µ—Ç! –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞ (–®–∞–≥ 3) –∏ CRON (–®–∞–≥ 4), –≤—Å—ë –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

**Q: –ß—Ç–æ –µ—Å–ª–∏ —è –Ω–µ —Ö–æ—á—É –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å CRON?**
A: –ú–æ–∂–Ω–æ! –£–ª—É—á—à–µ–Ω–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å —Å—Ç–∞—Ç—É—Å—ã –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —á–µ–∫–æ–≤. –ù–æ —Å—Ç–∞—Ç—É—Å—ã "—Å —Ç–µ—á–µ–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏" (–∫–æ–≥–¥–∞ –ø—Ä–æ–¥—É–∫—Ç –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è) –æ–±–Ω–æ–≤—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–∫—É–ø–∫–µ —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ –ø—Ä–æ–¥—É–∫—Ç–∞.

**Q: –ö–∞–∫ —á–∞—Å—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è CRON?**
A: –†–∞–∑ –≤ –¥–µ–Ω—å –≤ –ø–æ–ª–Ω–æ—á—å (00:00). –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤ —Å–∫—Ä–∏–ø—Ç–µ.

## üöÄ –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫–ª–∏—Å—Ç

- [x] –ü—Ä–∏–º–µ–Ω—ë–Ω –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä (`FIX_ALL_STATUSES.sql`)
- [x] –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–µ–∫—É—â–∏–µ —Å—Ç–∞—Ç—É—Å—ã –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (`UPDATE_PRODUCT_STATUSES.sql`)
- [ ] **–ü—Ä–∏–º–µ–Ω–∏—Ç—å —É–ª—É—á—à–µ–Ω–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä —Å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º** (`IMPROVED_TRIGGER_WITH_AUTO_UPDATE.sql`)
- [ ] **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å CRON –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** (`SETUP_DAILY_STATUS_UPDATE_CRON.sql`)

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤ —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π! ‚ú®

