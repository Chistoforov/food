# Исправление неправильных цен в приложении

## Проблема

После загрузки чека цены продуктов отображаются неправильно. Например:
- В чеке: Гуакамоле 200г - 1,95€
- В приложении: 9,75€ (в 5 раз больше!)

## Причина

API неправильно интерпретировал `quantity` для упакованных товаров:
- Вместо `quantity: 1` (1 упаковка) API вернул `quantity: 0.2` (считая 200г как 0.2кг)
- При расчете цены за единицу: `unitPrice = 1.95 / 0.2 = 9.75€` ❌

## Решение

### 1. Исправление для будущих чеков ✅

Уже исправлено! Обновлен промпт в `/src/services/perplexityService.ts`, теперь AI понимает:
- Для упакованных товаров (с весом в названии) `quantity = 1`
- `price` - это точная цена из чека

### 2. Исправление уже загруженных данных

#### Вариант A: Через SQL (рекомендуется)

1. Откройте Supabase Dashboard
2. Перейдите в SQL Editor
3. Выполните скрипт `fix_incorrect_prices.sql`

Скрипт автоматически:
- Находит продукты с неправильными ценами
- Исправляет их на основе данных из `product_history`
- Использует `unit_price` из последней покупки

#### Вариант B: Удалить чек и загрузить заново

1. Откройте приложение
2. Перейдите в раздел "Аналитика"
3. Найдите чек с неправильными данными
4. Удалите его
5. Загрузите чек снова - теперь цены будут правильными

#### Вариант C: Ручное исправление в UI

1. Откройте продукт в приложении
2. Отредактируйте цену вручную
3. Сохраните изменения

## Проверка

После исправления проверьте:
1. Цены продуктов соответствуют ценам в чеке
2. Статистика (общие расходы) корректна
3. История покупок показывает правильные цены

## Предотвращение в будущем

Улучшенный промпт теперь включает:
- ✅ Четкие инструкции для quantity (количество единиц, а не вес)
- ✅ Примеры для упакованных товаров
- ✅ Разъяснение разницы между единицами товара и весом
- ✅ Инструкция использовать точную цену из чека

## Техническая информация

### Как работает расчет цены

```typescript
// В supabaseService.ts
const unitPrice = item.quantity > 0 ? item.price / item.quantity : item.price

// Если quantity неправильный:
// unitPrice = 1.95 / 0.2 = 9.75€ ❌

// Если quantity правильный:
// unitPrice = 1.95 / 1 = 1.95€ ✅
```

### Структура данных

- `products.price` - цена за единицу товара (отображается в UI)
- `product_history.price` - общая цена покупки
- `product_history.unit_price` - цена за единицу (рассчитывается при сохранении)
- `product_history.quantity` - количество купленных единиц

## Дополнительно

Если проблема повторится:
1. Проверьте, что используется обновленная версия `perplexityService.ts`
2. Убедитесь, что прокси-сервер перезапущен
3. Проверьте логи в консоли браузера при загрузке чека
4. Обратитесь к разработчику для дополнительной настройки промпта

