# Инструкция по деплою изменений

## Что было изменено

### 1. Главная страница
- **Типы продуктов теперь показываются с агрегированным статусом**
- Вместо подсчета продуктов (`Всего: 2, Заканчивается: 1`) показывается единый статус типа (`Заканчивается`)
- Если хотя бы один продукт типа заканчивается, весь тип показывается как "Заканчивается"

### 2. Логика статусов
- **Правило 2-х дней**: продукт не может показывать статус "заканчивается" в течение 2 дней после покупки
- Это предотвращает ситуацию, когда только что купленный продукт сразу помечается как заканчивающийся

### 3. Автоматический пересчет
- **Cron job запускается раз в сутки в 1:00 UTC**
- Пересчитывает статусы всех продуктов для всех семей
- Применяет правило 2-х дней

## Измененные файлы

1. `src/GroceryTrackerApp.tsx` - изменено отображение типов продуктов
2. `src/services/supabaseService.ts` - добавлен метод `recalculateAllProductStatuses()`
3. `api/recalculate-statuses.js` - новый API endpoint для cron job
4. `vercel.json` - добавлена конфигурация cron job

## Шаги для деплоя

### 1. Коммит изменений

```bash
git add .
git commit -m "feat: обновлена логика статусов продуктов с правилом 2-х дней и cron job"
git push
```

### 2. Vercel автоматически задеплоит изменения

После пуша Vercel автоматически:
- Соберет проект
- Задеплоит изменения
- Активирует cron job

### 3. Проверка деплоя

1. Откройте https://your-app.vercel.app
2. Перейдите на главную страницу
3. Проверьте, что типы продуктов отображаются с новым дизайном

### 4. Проверка cron job

#### Проверить, что cron job настроен:

1. Откройте https://vercel.com/your-username/your-project
2. Перейдите в Settings → Cron Jobs
3. Убедитесь, что есть задача `/api/recalculate-statuses` с расписанием `0 1 * * *`

#### Протестировать cron job вручную:

```bash
curl https://your-app.vercel.app/api/recalculate-statuses
```

Ответ должен быть примерно таким:

```json
{
  "success": true,
  "timestamp": "2024-11-04T...",
  "familiesProcessed": 1,
  "totalProductsUpdated": 30,
  "totalErrors": 0,
  "results": [...]
}
```

### 5. Мониторинг первого автоматического запуска

Первый запуск произойдет в следующий раз в **1:00 UTC**.

Чтобы посмотреть логи:
1. Vercel Dashboard → Deployments
2. Выберите последний деплой
3. Functions → `api/recalculate-statuses.js`
4. Просмотрите логи выполнения

## Важные моменты

### Часовой пояс

Cron job запускается в **1:00 UTC**. Это соответствует:
- **4:00 MSK** (Москва, +3 UTC)
- **3:00 EET** (Восточноевропейское время, +2 UTC)
- **5:00 SAMT** (Самара, +4 UTC)

### Тарифные ограничения

- **Бесплатный план Vercel**: cron job может запускаться **максимум раз в день**
- Это именно то, что нам нужно (раз в сутки в 1:00)
- Для более частого запуска нужен Pro план

### Первый запуск

После деплоя первый автоматический запуск cron job произойдет в следующий раз в 1:00 UTC.

Вы можете запустить его вручную прямо сейчас:

```bash
curl https://your-app.vercel.app/api/recalculate-statuses
```

## Проверка работы

### Сценарий проверки правила 2-х дней:

1. Купите продукт сегодня (добавьте чек)
2. Продукт должен показывать статус "В наличии" или "Расчет..."
3. Даже если средняя частота покупки = 3 дня, продукт **не должен** показывать "Заканчивается" сегодня и завтра
4. Через 2 дня (на третий день) cron job пересчитает статусы
5. Если по расчетам продукт должен закончиться, он покажет статус "Заканчивается"

### Пример:

**Дано:**
- Продукт: Молоко
- Средняя частота покупки: 3 дня
- Дата последней покупки: 4 ноября

**Ожидаемое поведение:**

| Дата | Дней с покупки | Статус | Почему |
|------|----------------|--------|--------|
| 4 ноября | 0 | ✅ В наличии | Правило 2-х дней |
| 5 ноября | 1 | ✅ В наличии | Правило 2-х дней |
| 6 ноября | 2 | ✅ В наличии | Правило 2-х дней (еще не прошло) |
| 7 ноября (1:00) | 3 | ⚠️ Заканчивается | Прошло 3 дня = средняя частота |

## Откат изменений (если что-то пошло не так)

Если нужно откатить изменения:

```bash
# Откат последнего коммита
git revert HEAD

# Или откат к конкретному коммиту
git revert <commit-hash>

# Пуш изменений
git push
```

## Дополнительные настройки (опционально)

### Добавить секрет для защиты cron endpoint

В настройках Vercel добавьте переменную окружения:

```
CRON_SECRET=your-random-secret-token-here
```

После этого endpoint будет требовать авторизацию:

```bash
curl https://your-app.vercel.app/api/recalculate-statuses \
  -H "Authorization: Bearer your-random-secret-token-here"
```

Vercel автоматически добавит этот заголовок при автоматическом запуске cron job.

## Контакты для поддержки

Если возникли проблемы:

1. Проверьте логи в Vercel Dashboard
2. Проверьте переменные окружения (VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY)
3. Убедитесь, что база данных доступна

## Полезные ссылки

- [Документация Vercel Cron Jobs](https://vercel.com/docs/cron-jobs)
- [Cron Expression Generator](https://crontab.guru/)
- [Подробная документация](./PRODUCT_STATUS_CRON.md)

