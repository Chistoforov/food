# Функция виртуальной покупки

## Что это?

Функция виртуальной покупки позволяет корректировать прогноз расхода продуктов, когда система показывает, что продукт заканчивается, но на самом деле он еще есть дома.

## Как это работает?

### На главной странице

1. **Убрана надпись с количеством продуктов** - карточки типов продуктов теперь показывают только название и статус
2. **Кнопка виртуальной покупки** - появляется в правом нижнем углу карточек со статусом "Заканчивается"
   - Иконка: RefreshCw (круговая стрелка)
   - Цвет: зеленый (bg-green-600)
   - При клике: анимация вращения во время обработки
   - Имеет тень (shadow-md) для лучшей видимости

### Логика работы

**Пример с творогом:**

1. **До нажатия кнопки:**
   - Последняя покупка: 7 ноября
   - Avg_days: 3 дня
   - Predicted_end: 10 ноября
   - Статус: "заканчивается" ❌

2. **После нажатия кнопки (9 ноября):**
   - Система добавляет "виртуальную покупку" с датой 9 ноября
   - Виртуальная покупка имеет quantity=0, price=0 (не влияет на статистику расхода и трат)
   - Пересчитывается avg_days с учетом нового интервала между покупками
   - Обновляется predicted_end
   - Статус меняется на "ok" ✅

### Технические детали

**Виртуальная покупка:**
- `quantity = 0` - не влияет на расход
- `price = 0` - не влияет на статистику трат
- `unit_price = 0` - не влияет на цены
- `receipt_id = null` - не привязана к чеку
- `date = сегодня` - создает новый интервал для расчета avg_days

**Пересчет:**
1. Добавляется запись в `product_history` с параметрами виртуальной покупки
2. Обновляется `last_purchase` продукта на сегодняшнюю дату
3. Вызывается `updateProductStats()` для пересчета avg_days и predicted_end
4. Обновляется кэш статистики типов продуктов

## Файлы

### `/src/services/supabaseService.ts`
- Метод `addVirtualPurchase(productId, familyId)` - создание виртуальной покупки для одного продукта
- Метод `addVirtualPurchaseForType(productType, familyId)` - создание виртуальной покупки для всех продуктов типа (получает продукты напрямую из БД)

### `/src/GroceryTrackerApp.tsx`
- Состояние `virtualPurchaseLoading` - отслеживание загрузки
- Обработчик `handleVirtualPurchase(productType)` - обработка клика (использует `addVirtualPurchaseForType`)
- Кнопка с иконкой RefreshCw на карточках с ending-soon

## Использование

1. Откройте главную страницу
2. Найдите карточку продукта со статусом "Заканчивается" (оранжевая)
3. Нажмите кнопку с круговой стрелкой в правом нижнем углу
4. Дождитесь анимации загрузки
5. Статус продукта обновится автоматически

## Преимущества подхода

- ✅ Естественно вписывается в существующую логику
- ✅ История покупок сохраняется
- ✅ Не влияет на статистику расхода и трат
- ✅ Автоматически пересчитывает avg_days
- ✅ Работает для всех продуктов типа одновременно
- ✅ Не требует изменений в схеме базы данных

## Будущие улучшения

- Добавить аналитику по виртуальным покупкам (сколько раз корректировался каждый продукт)
- Возможность отмены виртуальной покупки
- История корректировок в интерфейсе

